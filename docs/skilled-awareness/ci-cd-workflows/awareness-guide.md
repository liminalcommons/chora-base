# Awareness Guide: CI/CD Workflows

**SAP ID**: SAP-005
**Version**: 1.0.1
**Target Audience**: AI agents
**Last Updated**: 2025-10-28

---

## 1. Quick Reference

### When to Use This SAP

**Use the CI/CD Workflows SAP when**:
- Understanding what GitHub Actions workflows are generated by chora-base
- Debugging workflow failures (test, lint, security, build)
- Modifying workflow configurations (.github/workflows/*.yml)
- Understanding quality gates (coverage 85%, type checking, linting)
- Troubleshooting CI/CD pipeline issues in generated projects

**Don't use for**:
- Non-GitHub CI systems (GitLab CI, CircleCI) - chora-base uses GitHub Actions
- Local development testing - use pytest/ruff directly, not workflow simulation
- Manual deployment - workflows automate this, don't bypass them
- Projects without CI/CD - chora-base generates with CI/CD by default

**View workflow status**:
```bash
# In GitHub UI: Actions tab → Select workflow → View runs
```

**Run workflow locally** (test.yml equivalent):
```bash
pytest --cov=src --cov-report=term --cov-fail-under=85
```

**Run workflow locally** (lint.yml equivalent):
```bash
ruff check .
mypy src
```

---

## 2. Agent Context Loading

**Essential Context (2-3k tokens)**:
- [protocol-spec.md](protocol-spec.md) Sections 2, 3 - Workflow inventory, specifications

**For debugging failures**:
- [protocol-spec.md](protocol-spec.md) Section 8 - Error handling

---

## 3. Common Workflows

### 3.1 Interpret Test Workflow Failure

**Context**: 2k tokens (Protocol Section 3.1)

**Steps**:
1. Check GitHub Actions logs
2. Identify failure type:
   - Tests failed → Check pytest output
   - Coverage <85% → Check coverage report
   - Cache miss → Normal (will rebuild cache)
3. Fix locally, push again

### 3.2 Modify Workflow Safely

**Context**: 3k tokens (Protocol Sections 3, 6)

**Steps**:
1. Read existing workflow (.github/workflows/<name>.yml)
2. Understand contract (triggers, guarantees from Protocol)
3. Make minimal changes
4. Test locally if possible
5. Commit and watch workflow run

---

## 4. Common Pitfalls

### Pitfall 1: Disabling Security Workflows Without Understanding Impact

**Scenario**: Agent removes CodeQL or Dependabot workflows thinking they're unnecessary.

**Example**:
```bash
# Agent sees CodeQL workflow taking time in CI
# Decides to "optimize" by removing it
rm .github/workflows/codeql.yml

# Push to GitHub
# Result: Security vulnerabilities no longer detected!
```

**Fix**: Understand security workflow purpose before removing:
```yaml
# .github/workflows/codeql.yml
# Purpose: Detect security vulnerabilities in code
# Runs on: push, pull_request, schedule (weekly)
# Cost: ~2-3 minutes per run
# Value: Catches SQL injection, XSS, hardcoded secrets

# Keep enabled! Security > speed
```

**Why it matters**: CodeQL detected 3 security issues in chora-base during development. Removing security workflows exposes projects to vulnerabilities. Protocol Section 3.3 mandates security workflows remain active.

### Pitfall 2: Modifying Workflow Without Testing Locally First

**Scenario**: Agent changes test.yml configuration, pushes, and breaks CI.

**Example**:
```yaml
# Agent modifies test.yml:
- name: Run tests
  run: pytest --cov=src --cov-fail-under=90  # Changed from 85% to 90%

# Push to GitHub
# Result: All tests fail! Coverage is 87%, below new 90% threshold
# Blocks all PRs until fixed
```

**Fix**: Test workflow changes locally before pushing:
```bash
# Test locally BEFORE modifying workflow:
pytest --cov=src --cov-fail-under=90
# Shows: FAILED (coverage: 87.3%, required: 90.0%)

# Don't push 90% threshold if you can't meet it
# Either: Keep 85% threshold OR increase coverage to 90% first
```

**Why it matters**: Broken CI blocks all development. Testing workflow commands locally takes 30 seconds, debugging broken CI takes 10-30 minutes. Protocol Section 8.1 documents testing workflows locally.

### Pitfall 3: Not Understanding Workflow Triggers

**Scenario**: Agent expects workflow to run but it doesn't trigger.

**Example**:
```yaml
# build.yml workflow:
on:
  push:
    tags:
      - 'v*'  # Only runs on version tags

# Agent pushes commit:
git push origin main
# Expects build workflow to run
# Result: Build workflow does NOT run! (no tag)
```

**Fix**: Understand workflow triggers (Protocol Section 3):
```yaml
# test.yml: Runs on ALL pushes and PRs
on: [push, pull_request]

# lint.yml: Runs on ALL pushes and PRs
on: [push, pull_request]

# build.yml: Runs ONLY on version tags
on:
  push:
    tags: ['v*']

# codeql.yml: Runs on push, PR, and weekly schedule
on:
  push:
  pull_request:
  schedule:
    - cron: '0 0 * * 0'  # Sunday midnight
```

**Why it matters**: Understanding triggers prevents confusion. Build workflows don't run on normal commits by design. Protocol Section 2.2 lists all workflow triggers.

### Pitfall 4: Ignoring Cache Misses as Errors

**Scenario**: Agent sees cache miss warning and thinks CI is broken.

**Example**:
```
# CI Output:
⚠ Cache miss for key: pip-cache-linux-3.11-<hash>
Installing dependencies from scratch...
✅ Tests passed

# Agent reports: "CI warning detected, investigating..."
# Spends 10 minutes debugging normal behavior
```

**Fix**: Understand cache behavior is normal:
```yaml
# Caching in test.yml:
- uses: actions/cache@v4
  with:
    key: pip-cache-${{ runner.os }}-${{ matrix.python-version }}-${{ hashFiles('pyproject.toml') }}

# Cache miss occurs when:
# 1. First run (no cache exists) - NORMAL
# 2. pyproject.toml changed (dependencies changed) - EXPECTED
# 3. Cache expired (>7 days old) - NORMAL

# Cache miss adds ~1-2 minutes to workflow time
# Not an error! Just rebuilding cache.
```

**Why it matters**: Cache misses are normal, not errors. Investigating normal behavior wastes time. Protocol Section 3.1 explains caching behavior.

### Pitfall 5: Not Reading Workflow Guarantees Before Relying on Them

**Scenario**: Agent assumes workflow provides feature it doesn't guarantee.

**Example**:
```yaml
# Agent assumes test.yml publishes coverage report to GitHub UI
# Writes: "Check coverage report in GitHub Actions"

# User clicks Actions → test workflow
# Result: No coverage report visible! (not guaranteed)

# test.yml only runs pytest --cov, doesn't publish to UI
```

**Fix**: Read Protocol Section 6 (Guarantees) before documenting workflows:
```yaml
# test.yml GUARANTEES:
# ✅ Tests run on push and PR
# ✅ Coverage measured (85% threshold)
# ✅ Fails if tests fail OR coverage <85%

# test.yml DOES NOT guarantee:
# ❌ Coverage report in GitHub UI (needs codecov action)
# ❌ Test result comments on PR (needs separate action)
# ❌ Coverage badge (needs shields.io)

# Don't document features workflows don't provide!
```

**Why it matters**: Wrong documentation misleads users. Protocol Section 6 explicitly lists what each workflow guarantees. Reading guarantees takes 2-3 minutes, user confusion takes 10-20 minutes to resolve.

---

## 5. Best Practices

**DO**:
- ✅ Use caching for pip dependencies
- ✅ Keep security workflows enabled
- ✅ Test locally before relying on CI

**DON'T**:
- ❌ Disable CodeQL or security workflows
- ❌ Skip required workflows
- ❌ Increase timeout without investigating root cause

---

## 6. Installation

### Quick Install

Install this SAP with its dependencies:

```bash
python scripts/install-sap.py SAP-005 --source /path/to/chora-base
```

This will automatically install:
- SAP-005 (CI/CD Workflows)
- SAP-000 (SAP Framework)
- SAP-004 (Testing Framework)
- SAP-003 (Project Bootstrap & Scaffolding)

### Part of Sets

This SAP is included in the following [standard sets](../../user-docs/reference/standard-sap-sets.md):

- `recommended` - 10 SAPs covering core development workflows
- `testing-focused` - 6 SAPs emphasizing testing and quality
- `mcp-server` - 10 SAPs for building MCP servers
- `full` - All 18 SAPs (complete capability suite)

To install a complete set:

```bash
python scripts/install-sap.py --set recommended --source /path/to/chora-base
```

### Dependencies

This SAP depends on:
- SAP-000 (SAP Framework)
- SAP-004 (Testing Framework)

All dependencies are automatically installed.

### Validation

After installation, verify the SAP artifacts exist:

```bash
ls docs/skilled-awareness/ci-cd-workflows/
# Should show: capability-charter.md, protocol-spec.md, awareness-guide.md, adoption-blueprint.md, ledger.md

# Verify GitHub Actions workflows exist
ls static-template/.github/workflows/
# Should show: test.yml and other CI/CD workflow files
```

### Custom Installation

For custom installation paths or options, see:
- [Install SAP Set How-To](../../user-docs/how-to/install-sap-set.md)
- [Install SAP Script Reference](../../user-docs/reference/install-sap-script.md)

---

## 7. Related Content

### Within This SAP (skilled-awareness/ci-cd-workflows/)

- [capability-charter.md](capability-charter.md) - Problem statement, scope, outcomes for SAP-005
- [protocol-spec.md](protocol-spec.md) - Complete technical contract (workflow specs, guarantees)
- [adoption-blueprint.md](adoption-blueprint.md) - Step-by-step guide for using workflows
- [ledger.md](ledger.md) - Workflow adoption tracking, version history
- **This document** (awareness-guide.md) - Agent workflows and troubleshooting

### Developer Process (dev-docs/)

**Workflows**:
- [dev-docs/workflows/TDD_WORKFLOW.md](../../dev-docs/workflows/TDD_WORKFLOW.md) - Test-driven development (integrates with test.yml)
- [dev-docs/workflows/BDD_WORKFLOW.md](../../dev-docs/workflows/BDD_WORKFLOW.md) - Behavior-driven development

**Tools**:
- [dev-docs/tools/ruff.md](../../dev-docs/tools/ruff.md) - Linting tool (used in lint.yml)
- [dev-docs/tools/mypy.md](../../dev-docs/tools/mypy.md) - Type checking (used in lint.yml)
- [dev-docs/tools/pytest.md](../../dev-docs/tools/pytest.md) - Testing tool (used in test.yml)

**CI/CD Guidelines**:
- [dev-docs/guides/ci-cd-best-practices.md](../../dev-docs/guides/ci-cd-best-practices.md) - CI/CD best practices

### Project Lifecycle (project-docs/)

**Implementation Components**:
- [static-template/.github/workflows/](/static-template/.github/workflows/) - Workflow files (test.yml, lint.yml, build.yml, codeql.yml)
- [static-template/.github/dependabot.yml](/static-template/.github/dependabot.yml) - Dependency updates

**Guides**:
- [project-docs/guides/ci-cd-setup.md](../../project-docs/guides/ci-cd-setup.md) - Setting up CI/CD in projects
- [project-docs/guides/troubleshooting-ci.md](../../project-docs/guides/troubleshooting-ci.md) - Debugging CI/CD failures

**Audits & Releases**:
- [project-docs/audits/](../../project-docs/audits/) - SAP audits including SAP-005 validation
- [project-docs/releases/](../../project-docs/releases/) - Version release documentation

### User Guides (user-docs/)

**Getting Started**:
- [user-docs/guides/github-actions.md](../../user-docs/guides/github-actions.md) - Understanding GitHub Actions

**Tutorials**:
- [user-docs/tutorials/debugging-ci-failures.md](../../user-docs/tutorials/debugging-ci-failures.md) - Debug CI failures
- [user-docs/tutorials/customizing-workflows.md](../../user-docs/tutorials/customizing-workflows.md) - Customize workflows

**Reference**:
- [user-docs/reference/workflow-reference.md](../../user-docs/reference/workflow-reference.md) - Workflow reference documentation

### Other SAPs (skilled-awareness/)

**Core Framework**:
- [sap-framework/](../sap-framework/) - SAP-000 (defines SAP structure)
- [chora-base/protocol-spec.md](../chora-base/protocol-spec.md) - SAP-002 Meta-SAP Section 3.2.3 (documents SAP-005)

**Dependent Capabilities**:
- [testing-framework/](../testing-framework/) - SAP-004 (test.yml runs tests per SAP-004 standards)
- [quality-gates/](../quality-gates/) - SAP-006 (lint.yml enforces SAP-006 quality gates)
- [project-bootstrap/](../project-bootstrap/) - SAP-003 (generates workflow files)

**Supporting Capabilities**:
- [automation-scripts/](../automation-scripts/) - SAP-008 (scripts used in workflows)
- [metrics-tracking/](../metrics-tracking/) - SAP-013 (workflow metrics)

**Core Documentation**:
- [README.md](/README.md) - chora-base overview
- [AGENTS.md](/AGENTS.md) - Agent guidance for using chora-base
- [CHANGELOG.md](/CHANGELOG.md) - Version history including SAP-005 updates
- [SKILLED_AWARENESS_PACKAGE_PROTOCOL.md](/SKILLED_AWARENESS_PACKAGE_PROTOCOL.md) - Root SAP protocol

---

**Version History**:
- **1.0.1** (2025-10-28): Added "When to Use" section, "Common Pitfalls" with Wave 2 learnings (5 scenarios: Security workflows, testing locally, workflow triggers, cache misses, workflow guarantees), enhanced "Related Content" with 4-domain coverage (dev-docs/, project-docs/, user-docs/, skilled-awareness/)
- **1.0.0** (2025-10-28): Initial awareness guide

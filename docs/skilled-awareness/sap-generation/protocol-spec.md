# Protocol Specification: SAP Generation Automation

**SAP ID**: SAP-029
**Version**: 1.0.0
**Status**: pilot
**Last Updated**: 2025-11-02

---

## 1. Overview

Template-based SAP artifact generation to reduce creation time from 10 hours to 2 hours (80% savings)


### Key Capabilities


- Jinja2 template system (5 templates for 5 artifacts)

- MVP generation schema (9 fields: owner, created_date, problem, evidence, impact, solution, principles, in_scope, out_of_scope, one_sentence_summary)

- Generator script (scripts/generate-sap.py)

- INDEX.md auto-update

- Validation integration



---

## 2. Core Contracts

### 2.1 Generated Artifact Frontmatter Schema

All SAP artifacts generated by SAP-029 MUST include generation metadata in their YAML frontmatter. This enables tracking of generation provenance, completion status, and regeneration safety.

**Complete Frontmatter Schema for Generated Artifacts**:

```yaml
---
sap_id: SAP-NNN
artifact: capability-charter | protocol-spec | awareness-guide | adoption-blueprint | ledger
version: X.Y.Z
status: draft | pilot | active | deprecated
last_updated: YYYY-MM-DD

# Generation Metadata (Phase 2.3) - REQUIRED for generated artifacts
generation:
  generated: true                        # This artifact was generated (vs hand-written)
  generator: "sap-generation"            # Generator name
  generator_version: "1.0.0"             # SAP-029 version used
  generated_date: "YYYY-MM-DDTHH:MM:SSZ" # ISO 8601 timestamp
  template_version: "1.2.0"              # Template version used
  last_manual_edit: "YYYY-MM-DDTHH:MM:SSZ" # Last time human edited (initially same as generated_date)
  todos_remaining: 15                    # Count of TODO placeholders in artifact
  completion_percent: 75                 # Estimated completion (0-100)
  regeneration_safe: false               # Safe to regenerate? (true if no manual edits)
---
```

**Field Definitions**:

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `generation.generated` | boolean | âœ… Yes | `true` if generated, `false` if hand-written |
| `generation.generator` | string | âœ… Yes | Name of generator (always `"sap-generation"` for SAP-029) |
| `generation.generator_version` | semver | âœ… Yes | Version of SAP-029 used for generation |
| `generation.generated_date` | datetime | âœ… Yes | ISO 8601 timestamp when artifact was generated |
| `generation.template_version` | semver | âœ… Yes | Version of Jinja2 template used |
| `generation.last_manual_edit` | datetime | âœ… Yes | ISO 8601 timestamp of last human edit |
| `generation.todos_remaining` | integer | âœ… Yes | Count of `TODO` placeholders in artifact body |
| `generation.completion_percent` | integer | âœ… Yes | Estimated completion (0-100), based on TODOs filled |
| `generation.regeneration_safe` | boolean | âœ… Yes | `true` if no manual edits since generation, `false` otherwise |

**Curation Benefits**:

1. **Know What Needs Work**: Filter SAPs by `todos_remaining > 0` to find incomplete artifacts
2. **Track Progress**: Sort by `completion_percent` to prioritize low-completion SAPs
3. **Safe Regeneration**: Only regenerate artifacts where `regeneration_safe: true`
4. **Template Versioning**: Identify artifacts using old templates via `template_version`
5. **Manual vs Generated**: Distinguish hand-crafted vs generated content

**Example Usage**:

```bash
# Find all generated artifacts with TODOs
grep -r "todos_remaining:" docs/skilled-awareness/ | grep -v ": 0"

# Find artifacts safe to regenerate (no manual edits)
grep -r "regeneration_safe: true" docs/skilled-awareness/

# Find artifacts using old template versions
grep -r "template_version: \"1.0.0\"" docs/skilled-awareness/
```

**Automatic Updates**:

When a human edits a generated artifact:
1. `last_manual_edit` MUST be updated to current timestamp
2. `regeneration_safe` MUST be set to `false`
3. `todos_remaining` SHOULD be decremented if TODOs resolved
4. `completion_percent` SHOULD be updated based on remaining TODOs

**Integration with SAP-019 (Self-Evaluation)**:

sap-evaluator.py SHOULD use generation metadata to:
- Flag SAPs with `completion_percent < 80%` as incomplete
- Warn if attempting to elevate SAP with `todos_remaining > 5` to `active` status
- Suggest regeneration for artifacts with old `template_version`

---

### 2.2 Template Variables for Quick Reference Sections

**Added**: 2025-11-10 (Batch 11-15 Pattern Integration)

The awareness-guide.j2 template now includes a standardized Quick Reference section (ðŸ“– Quick Reference) that provides 60-70% token savings for AI agents. This section requires the following optional fields in the `generation` section of sap-catalog.json:

**Quick Reference Template Variables**:

| Variable | Type | Required | Default | Description |
|----------|------|----------|---------|-------------|
| `quick_ref_read_time` | string | No | `"10-min"` | Estimated README reading time (e.g., "5-min", "15-min") |
| `quick_ref_quick_start` | string | No | Placeholder | One-line Quick Start description with time estimate |
| `quick_ref_time_savings` | string | No | Placeholder | Time savings metrics (e.g., "90% reduction (30h â†’ 3h)") |
| `quick_ref_feature_1_label` | string | No | `"Key Feature 1"` | Label for first key feature (e.g., "Type Safety") |
| `quick_ref_feature_1` | string | No | Placeholder | Description of first key feature |
| `quick_ref_feature_2_label` | string | No | `"Key Feature 2"` | Label for second key feature |
| `quick_ref_feature_2` | string | No | Placeholder | Description of second key feature |
| `quick_ref_feature_3_label` | string | No | `"Key Feature 3"` | Label for third key feature |
| `quick_ref_feature_3` | string | No | Placeholder | Description of third key feature |
| `quick_ref_purpose` | string | No | Auto-generated | Purpose statement for awareness-guide.md |

**Example sap-catalog.json Entry with Quick Reference Fields**:

```json
{
  "id": "SAP-042",
  "name": "example-sap",
  "version": "1.0.0",
  "description": "Example SAP with Quick Reference fields",
  "dependencies": ["SAP-000"],
  "location": "docs/skilled-awareness/example-sap",
  "generation": {
    "owner": "Your Name",
    "created_date": "2025-11-10",
    "problem_statement": "...",
    "solution_overview": "...",
    "key_principles": [...],
    "in_scope": [...],
    "out_of_scope": [...],
    "one_sentence_summary": "...",

    "quick_ref_read_time": "8-min",
    "quick_ref_quick_start": "5-minute setup with complete TypeScript examples",
    "quick_ref_time_savings": "90% time reduction (30 hours â†’ 3 hours)",
    "quick_ref_feature_1_label": "Type Safety",
    "quick_ref_feature_1": "100% TypeScript coverage with runtime validation",
    "quick_ref_feature_2_label": "Performance",
    "quick_ref_feature_2": "Zero-config caching with 95% hit rate",
    "quick_ref_feature_3_label": "Developer Experience",
    "quick_ref_feature_3": "IntelliSense support with comprehensive JSDoc"
  }
}
```

**Integration Note**: If quick_ref fields are omitted, the template uses placeholder text with TODO comments, allowing manual completion after generation.

**Validation**: The Quick Reference section can be validated using:
```bash
python scripts/validate-quick-reference.py --sap SAP-042
```

---

### 2.3 SAP Generation Contract

**Generator Script**: `scripts/generate-sap.py`

**Input Contract**:

```python
def generate_sap(
    sap_id: str,                    # SAP-NNN identifier
    metadata: Dict[str, Any],       # 9 MVP fields from sap-catalog.json
    template_version: str = "1.2.0", # Template version to use
    output_dir: str = "docs/skilled-awareness/",
    dry_run: bool = False
) -> GenerationResult:
    """
    Generate 5 SAP artifacts from Jinja2 templates.

    Returns:
        GenerationResult with:
        - files_generated: List[str]
        - todos_count: Dict[str, int]  # artifact -> TODO count
        - completion_estimate: Dict[str, float]  # artifact -> 0.0-1.0
    """
```

**Output Contract**:

For each SAP, generates 5 markdown files with:
- Complete YAML frontmatter (including generation metadata)
- Template-filled content with TODO placeholders
- Validation-ready structure (passes sap-validate.py)

---

## 3. Integration Patterns

SAP-029 integrates with the SAP ecosystem to provide automated artifact generation. Key integration points:

1. **SAP-000 (SAP Framework)**: Consumes SAP artifact structure specifications, validates generated artifacts against SAP-000 protocols
2. **sap-catalog.json**: Reads SAP metadata (id, name, description, tags) as input for template rendering
3. **SAP-019 (Self-Evaluation)**: Generated artifacts include metadata for sap-evaluator.py validation
4. **SAP-005 (CI/CD Workflows)**: Generator script can be invoked in GitHub Actions/GitLab CI for automated SAP creation
5. **SAP-016 (Link Validation)**: Generated artifacts include link placeholders that integrate with link validation workflows


### Dependencies Integration


#### Integration with SAP-000

**Integration Point**: SAP-000 defines the 5-artifact structure (capability-charter, protocol-spec, awareness-guide, adoption-blueprint, ledger) that SAP-029 generates. Templates conform to SAP-000 section requirements.

**Configuration**:
```yaml
sap-generation:
  sap_framework_version: "4.0.0"  # SAP-000 version to conform to
  artifact_templates:
    capability-charter: templates/sap/capability-charter.md.j2
    protocol-spec: templates/sap/protocol-spec.md.j2
    awareness-guide: templates/sap/awareness-guide.md.j2
    adoption-blueprint: templates/sap/adoption-blueprint.md.j2
    ledger: templates/sap/ledger.md.j2
```

**Validation**: Generated artifacts MUST pass `python scripts/sap-evaluator.py --quick {SAP_ID}` which validates SAP-000 compliance.




### External Integrations

**Integration 1**: Jinja2 Template Engine
- **Purpose**: Core templating system for artifact generation. Jinja2 provides variable substitution, loops, conditionals, and filters for generating SAP markdown content.
- **Configuration**:
  ```python
  from jinja2 import Environment, FileSystemLoader
  env = Environment(
      loader=FileSystemLoader('templates/sap/'),
      trim_blocks=True,
      lstrip_blocks=True
  )
  ```

**Integration 2**: sap-catalog.json (Project Configuration)
- **Purpose**: Source of truth for SAP metadata. Generator reads catalog to populate template variables (sap_id, name, description, tags, dependencies).
- **Configuration**: Add SAP entry to `sap-catalog.json` before generation:
  ```json
  {
    "id": "SAP-030",
    "name": "database-migrations",
    "description": "Database migration automation",
    "tags": ["backend", "database"],
    "dependencies": ["SAP-000"]
  }
  ```

**Integration 3**: GitHub Actions / CI/CD Pipelines
- **Purpose**: Automate SAP generation in continuous integration workflows
- **Configuration**: See adoption-blueprint.md Level 3, Step 3.1 for GitHub Actions workflow example

---

## 4. Configuration

Configuration for SAP-029 is stored in `.chora/config.yaml` (project root). The configuration defines template paths, schema fields, generation behavior, and integration settings.

**Configuration File Format**: YAML

### Configuration Schema

```yaml
sap-generation:
  enabled: true  # Enable SAP generation capability
  level: 1  # Adoption level (1: Basic, 2: Advanced, 3: Mastery)

  # Template Configuration (REQUIRED)
  templates:
    path: templates/sap/  # Base template directory
    version: "1.2.0"  # Template version
    cache_enabled: false  # Cache compiled templates (Level 3)

  # Schema Configuration (Level 1: MVP, Level 2+: Extended)
  schema:
    mvp_fields:  # 9 MVP fields for Level 1
      - sap_id
      - name
      - description
      - problem
      - solution
      - principles
      - in_scope
      - out_of_scope
      - one_sentence_summary
    extended_fields: []  # Level 2: Add stakeholders, metrics, etc.

  # Generation Behavior
  generation:
    output_dir: docs/skilled-awareness/
    auto_add_to_catalog: false  # Auto-update sap-catalog.json
    update_index: true  # Auto-update INDEX.md
    force_overwrite: false  # Overwrite existing files without --force flag

  # Validation (Level 2+)
  validation:
    auto_validate: false  # Run sap-evaluator.py after generation
    fail_on_error: false  # Exit with error if validation fails
    todo_threshold: 10  # Max TODOs for quality gate (Level 3)

  # CI/CD Integration (Level 3)
  ci_cd:
    enabled: false
    platform: github_actions  # or gitlab_ci, jenkins
    auto_pr_creation: false

  # Advanced Features (Level 3)
  advanced:
    parallel_generation: false  # Generate multiple SAPs concurrently
    dependency_resolution: false  # Auto-generate dependent SAPs
    template_caching: false  # Cache Jinja2 templates
```

**Validation Rules**:
- `templates.path` MUST exist and contain `.j2` template files
- `level` MUST be 1, 2, or 3
- `validation.todo_threshold` MUST be >= 0
- `schema.mvp_fields` MUST contain at least 5 fields

### Environment Variables

| Variable | Required | Default | Description |
|----------|----------|---------|-------------|
| `SAP_GENERATION_ENABLED` | No | `true` | Enable/disable SAP generation capability |
| `SAP_GENERATION_TEMPLATE_PATH` | No | `templates/sap/` | Override template directory path |
| `SAP_GENERATION_OUTPUT_DIR` | No | `docs/skilled-awareness/` | Override output directory |
| `SAP_GENERATION_LEVEL` | No | `1` | Override adoption level (1, 2, or 3) |
| `PYTHONIOENCODING` | No | `utf-8` | Python I/O encoding (required on Windows to handle Unicode in sap-evaluator output)

---

## 5. Error Handling

SAP-029 defines structured error codes for common failure scenarios. All errors are logged to `.chora/logs/sap-generation.log` if logging is enabled.

### Error Codes

| Code | Error | Cause | Resolution |
|------|-------|-------|------------|
| `SAP-029-001` | SAP Not Found in Catalog | SAP ID doesn't exist in sap-catalog.json | Add SAP entry to catalog first, or check spelling (SAP-030 not SAP030) |
| `SAP-029-002` | Template Not Found | Jinja2 template file missing or incorrect path | Verify templates/sap/ contains required .j2 files (5 artifact templates) |
| `SAP-029-003` | Template Syntax Error | Invalid Jinja2 syntax in template | Fix Jinja2 errors: missing `{% endfor %}`, unescaped `{{`, undefined variables |
| `SAP-029-004` | Permission Denied | Write permissions issue for output directory | Check directory ownership: `chmod -R u+w docs/skilled-awareness/` |
| `SAP-029-005` | SAP Already Exists | Target SAP directory already exists | Use `--force` flag to overwrite, or delete existing directory first |
| `SAP-029-006` | Invalid Schema | Catalog entry missing required MVP fields | Ensure SAP entry has: id, name, description, problem, solution, principles |
| `SAP-029-007` | Unicode Encoding Error | Windows console encoding issue (cp1252 can't handle emoji) | Set `PYTHONIOENCODING=utf-8` or use UTF-8 console |
| `SAP-029-008` | Validation Failed | Generated SAP doesn't pass sap-evaluator.py | Review validation output, fix artifact structure issues |

**Exception Hierarchy**:
```python
class SAPGenerationError(Exception):
    """Base exception for SAP generation errors"""

class TemplateNotFoundError(SAPGenerationError):
    """Error code SAP-029-002"""

class TemplateSyntaxError(SAPGenerationError):
    """Error code SAP-029-003"""

class SAPAlreadyExistsError(SAPGenerationError):
    """Error code SAP-029-005"""
```

### Common Errors

**Error: `jinja2.exceptions.UndefinedError: 'sap' is undefined`**
- **Cause**: Template references undefined variable `sap.field_name`. Catalog entry missing field.
- **Solution**: Add missing field to SAP entry in sap-catalog.json, or update template to handle missing field with `{{ sap.field_name | default('N/A') }}`

**Error: `FileExistsError: [Errno 17] File exists: 'docs/skilled-awareness/database-migrations/'`**
- **Cause**: SAP directory already exists from previous generation
- **Solution**: Use `python scripts/generate-sap.py SAP-030 --force` to overwrite, or `rm -rf docs/skilled-awareness/database-migrations/` first

**Logging**: Enable debug logging with `--verbose` flag:
```bash
python scripts/generate-sap.py SAP-030 --verbose 2>&1 | tee generation.log
```

---

## 6. Security Considerations

SAP-029 is a local code generation tool with minimal security risks. Key considerations:

**1. Template Injection Prevention**:
- **Risk**: Malicious templates could execute arbitrary Python code via Jinja2's `eval()` or `exec()`
- **Mitigation**: Disable Jinja2 autoescape and restrict template features:
  ```python
  env = Environment(
      loader=FileSystemLoader('templates/sap/'),
      autoescape=False,  # Markdown output, not HTML
      enable_async=False,  # Disable async features
      finalize=lambda x: x if x is not None else ''  # Null-safe
  )
  # Do NOT use: env.globals['__builtins__'] (allows arbitrary code)
  ```
- **Best Practice**: Review all templates before using. Store templates in version-controlled directories only.

**2. Path Traversal Prevention**:
- **Risk**: Malicious SAP IDs like `../../etc/passwd` could write outside intended directory
- **Mitigation**: Sanitize SAP IDs:
  ```python
  import os
  safe_id = os.path.basename(sap_id)  # Remove path components
  if safe_id != sap_id:
      raise ValueError(f"Invalid SAP ID: {sap_id}")
  ```

**3. Secret Management**:
- **Risk**: Generated SAPs might accidentally include secrets (API keys, passwords) in examples or configuration
- **Mitigation**:
  - Use placeholder values in templates: `api_key: "YOUR_API_KEY_HERE"`, not real credentials
  - Add `.chora/config.yaml` to `.gitignore` if it contains environment-specific secrets
  - Use secret scanning tools (e.g., git-secrets, trufflehog) on generated artifacts before commit

**4. Dependency Security**:
- **Risk**: Jinja2 library vulnerabilities (CVE-2019-10906, CVE-2020-28493)
- **Mitigation**: Keep Jinja2 updated to latest stable version (3.1.2+). Run `pip install --upgrade jinja2` regularly.

**Known Vulnerabilities**: None specific to SAP-029 (as of 2025-11-02). Monitor Jinja2 security advisories.


---

## 7. Performance Requirements

SAP generation performance targets ensure acceptable user experience. Targets vary by adoption level.

### Performance Targets

| Metric | Target (Level 1) | Target (Level 3) | Measurement |
|--------|------------------|------------------|-------------|
| **Generation Time** | < 5 minutes | < 30 seconds | Time from script invocation to completion (5 artifacts) |
| **Throughput** | 1 SAP/5min | 12 SAPs/5min (parallel) | SAPs generated per unit time |
| **Memory Usage** | < 100 MB | < 250 MB | Peak RAM during generation (measured with `memory_profiler`) |
| **Template Compile Time** | 2-3 seconds | < 500ms (cached) | Time to compile Jinja2 templates |
| **TODO Count** | 60-105 per SAP | <10 per SAP | Manual work remaining after generation |

**Scalability Considerations**:
- **Level 1**: Sequential generation. Time complexity O(N) where N = number of SAPs
- **Level 3**: Parallel generation. Time complexity O(N/K) where K = CPU cores (8 cores: ~8x speedup)
- **Bottleneck**: Disk I/O for writing files. Use SSD for best performance (5x faster than HDD)

**Performance Monitoring**:
```bash
# Benchmark generation time
time python scripts/generate-sap.py SAP-030

# Benchmark with memory profiling
python -m memory_profiler scripts/generate-sap.py SAP-030

# Benchmark batch generation (Level 3)
time python scripts/generate-sap.py --batch batch-generate.yaml --parallel
```

**Optimization Techniques** (Level 3):
1. **Template Caching**: Compile templates once, reuse 50+ times (50-70% time savings)
2. **Parallel Generation**: Use `multiprocessing` to generate N SAPs concurrently
3. **Lazy Loading**: Load catalog only once, share across parallel workers
4. **Incremental Updates**: Only regenerate changed artifacts (--incremental flag)

---

## 8. Examples

### Example 1: Basic Usage - Generate a Single SAP

**Scenario**: First-time SAP generation (Level 1). Create SAP-030 for database migrations.

```bash
# Step 1: Add SAP entry to catalog
cat >> sap-catalog.json <<EOF
{
  "id": "SAP-030",
  "name": "database-migrations",
  "status": "draft",
  "version": "0.1.0",
  "description": "Database migration automation for Python projects",
  "tags": ["backend", "database", "automation"],
  "dependencies": ["SAP-000"]
}
EOF

# Step 2: Generate SAP artifacts
python scripts/generate-sap.py SAP-030

# Step 3: Validate generated SAP
python scripts/sap-evaluator.py --quick SAP-030
```

**Expected Output**:
```
ðŸ” Generating SAP-030 (database-migrations)...
âœ… Created docs/skilled-awareness/database-migrations/
âœ… Generated capability-charter.md (45 lines, 8 TODOs)
âœ… Generated protocol-spec.md (120 lines, 15 TODOs)
âœ… Generated awareness-guide.md (95 lines, 12 TODOs)
âœ… Generated adoption-blueprint.md (180 lines, 25 TODOs)
âœ… Generated ledger.md (60 lines, 5 TODOs)

ðŸ“Š Summary: 5 files created, 65 TODOs to fill
â±ï¸ Estimated manual fill time: 2-3 hours
```

### Example 2: Advanced Usage - Batch Generation with Custom Domain

**Scenario**: Level 2 adoption. Generate 3 frontend SAPs using domain-specific templates.

```bash
# Step 1: Create batch configuration
cat > batch-generate.yaml <<EOF
batch:
  - id: SAP-031
    name: routing-navigation
    domain: frontend
    tags: ["frontend", "react", "nextjs"]
  - id: SAP-032
    name: performance-optimization
    domain: frontend
    tags: ["frontend", "react", "performance"]
  - id: SAP-033
    name: data-fetching
    domain: frontend
    tags: ["frontend", "react", "api"]
EOF

# Step 2: Run batch generation
python scripts/generate-sap.py --batch batch-generate.yaml

# Step 3: Validate all SAPs
for sap in SAP-031 SAP-032 SAP-033; do
  python scripts/sap-evaluator.py --quick $sap
done
```

### Example 3: Level 3 - CI/CD Integration with Quality Gates

**Scenario**: Production deployment. Auto-generate SAP via GitHub Actions with quality gate enforcement.

```yaml
# .github/workflows/generate-sap.yml
name: Generate SAP with Quality Gates
on:
  workflow_dispatch:
    inputs:
      sap_id:
        required: true

jobs:
  generate-and-validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - run: pip install jinja2
      - name: Generate SAP
        run: python scripts/generate-sap.py ${{ github.event.inputs.sap_id }}
      - name: Quality Gate
        run: python scripts/quality-gate-sap.py ${{ github.event.inputs.sap_id }} 10
      - name: Create PR
        uses: peter-evans/create-pull-request@v5
        with:
          title: "feat: Generate ${{ github.event.inputs.sap_id }}"
```

---

## 9. Validation & Testing

### Validation Criteria

A SAP is considered validly generated if:
1. All 5 artifacts exist in correct directory (`docs/skilled-awareness/{sap-name}/`)
2. Each artifact has valid YAML frontmatter with `generation` metadata
3. Artifacts pass sap-evaluator.py structure validation
4. Generated content contains expected sections per SAP-000 specification
5. TODO count is within expected range (60-105 for technical SAPs, 40-80 for meta SAPs)

### Validation Commands

```bash
# Quick validation (30 seconds) - Verify SAP-029 artifacts present and valid
python scripts/sap-evaluator.py --quick SAP-029

# Expected output:
# âœ… SAP-029 (sap-generation)
#    Level: 1
#    Next: Level 2
# âœ… Validation passed

# Alternative using justfile
just validate-sap SAP-029

# Full validation (detailed report)
python scripts/sap-evaluator.py SAP-029

# Validate generation script itself
python scripts/generate-sap.py SAP-030 --dry-run

# Expected: Shows 5 artifacts that would be generated without creating them
```

### Test Cases

**Test Case 1**: Generate SAP with MVP Schema
- **Given**: Fresh repository with SAP-030 entry in catalog (9 MVP fields populated)
- **When**: Run `python scripts/generate-sap.py SAP-030`
- **Then**: 5 artifacts created, each with valid frontmatter, 60-80 TODOs total, passes sap-evaluator validation

**Test Case 2**: Generate SAP with Missing Catalog Entry
- **Given**: SAP-035 NOT in sap-catalog.json
- **When**: Run `python scripts/generate-sap.py SAP-035`
- **Then**: Error SAP-029-001 raised, no files created, helpful error message suggesting to add catalog entry

**Test Case 3**: Regenerate Existing SAP with --force
- **Given**: SAP-030 directory already exists from previous generation
- **When**: Run `python scripts/generate-sap.py SAP-030 --force`
- **Then**: Existing files overwritten, warning logged, new generation metadata in frontmatter

**Test Case 4**: Batch Generation (Level 2)
- **Given**: batch-generate.yaml with 3 SAP IDs
- **When**: Run `python scripts/generate-sap.py --batch batch-generate.yaml`
- **Then**: 15 total artifacts created (3 SAPs Ã— 5 artifacts), all pass validation

**Test Case 5**: Quality Gate Enforcement (Level 3)
- **Given**: Generated SAP-030 with 15 TODOs remaining
- **When**: Run `python scripts/quality-gate-sap.py SAP-030 10` (threshold: 10 TODOs)
- **Then**: Quality gate fails, exit code 1, error message "15 TODOs exceeds threshold of 10"

---

## 10. Versioning & Compatibility

SAP-029 follows **Semantic Versioning 2.0.0** (semver.org) with SAP-specific compatibility guarantees.

### Version Numbering Scheme

**Format**: `MAJOR.MINOR.PATCH` (e.g., 1.2.3)

- **MAJOR** (x.0.0): Breaking changes to template structure, schema requirements, or generator API
  - Example: Changing MVP schema from 9 to 12 required fields
  - Migration guide REQUIRED in ledger.md

- **MINOR** (1.x.0): Backward-compatible new features (new template fields, new CLI flags)
  - Example: Adding --domain flag for domain-specific templates
  - Existing workflows unaffected

- **PATCH** (1.0.x): Backward-compatible bug fixes only
  - Example: Fixing Unicode encoding issue in Windows
  - No user-facing changes beyond bug resolution

### Version Compatibility

**Current Version**: 1.0.0

**Compatibility Guarantees**:
- Generated SAPs track `generator_version` in frontmatter
- Templates track `template_version` in frontmatter
- Generator MUST support artifacts generated by previous MINOR versions (e.g., 1.2.0 can regenerate 1.1.0 artifacts)
- Generator SHOULD warn when regenerating artifacts with old template versions (>6 months old)

**Breaking Changes Policy**:
- MAJOR version bumps REQUIRE 90-day deprecation notice in CHANGELOG
- Migration scripts provided for MAJOR version transitions
- Legacy compatibility mode available for 1 MAJOR version back (e.g., 2.0.0 supports 1.x.x artifacts in legacy mode)

**Deprecation Policy**:
1. Feature marked deprecated in CHANGELOG with migration path
2. Deprecation warnings added to CLI output
3. Feature removed in next MAJOR version (minimum 90 days after deprecation)

**Migration Paths**:
- MAJOR version migrations documented in adoption-blueprint.md "Migration Paths" section
- `scripts/migrate-sap-version.py` provided for automated migration (Level 3)


### Dependency Compatibility

| Dependency | Minimum Version | Tested Version | Status |
|------------|----------------|----------------|--------|

| SAP-000 | 1.0.0 | Latest | âœ… Compatible |



---

## 11. Related Specifications

### Within chora-base

**SAP Artifacts**:
- [Capability Charter](./capability-charter.md) - Problem statement and scope
- [Awareness Guide](./awareness-guide.md) - AI agent quick reference
- [Adoption Blueprint](./adoption-blueprint.md) - Step-by-step installation
- [Traceability Ledger](./ledger.md) - Version history and adoption tracking

**Related SAPs**:
- [SAP-000: SAP Framework](../sap-framework/protocol-spec.md) - Core SAP protocols


- [SAP-000](../[directory]/protocol-spec.md) - [Description of relationship]



### External Specifications

- [Semantic Versioning 2.0.0](https://semver.org/) - Version numbering specification
- [Jinja2 Template Documentation](https://jinja.palletsprojects.com/en/3.1.x/) - Template engine specification
- [YAML 1.2 Specification](https://yaml.org/spec/1.2/spec.html) - Configuration file format
- [ISO 8601 Date/Time Standard](https://www.iso.org/iso-8601-date-and-time-format.html) - Timestamp format in frontmatter
- [GitHub Actions Workflow Syntax](https://docs.github.com/en/actions/reference/workflow-syntax-for-github-actions) - CI/CD integration
- [Python PEP 8 Style Guide](https://pep8.org/) - Generator script coding standards

---

**Version History**:
- **1.0.0** (2025-11-02): Initial protocol specification for SAP Generation Automation
# Upgrade Guide: v2.0.7 ‚Üí v2.0.8

**Version:** chora-base v2.0.7 ‚Üí v2.0.8
**Release Date:** 2025-10-23
**Type:** PATCH (bug fix)
**Effort:** 5-10 minutes
**Risk:** LOW (template fixes only)

---

## Overview

**What Changed:**

v2.0.8 fixes the template syntax errors that prevented v2.0.7 from working. The delimiter choice (standard `{{ }}`) was correct, but the migration script corrupted shell/Python/TOML/YAML syntax.

**Key Fixes:**

1. **NAMESPACES.md** - Created static version (workaround for Copier bug)
2. **Shell Scripts** - Fixed heredocs, here-strings, test expressions (15+ files)
3. **Python Files** - Wrapped bash templates in `{% raw %}` blocks
4. **TOML Files** - Fixed array of tables syntax
5. **GitHub Actions** - Fixed shell syntax in workflows

**Impact:**

- ‚úÖ Template now generates complete projects successfully
- ‚úÖ All shell/Python/TOML/YAML syntax preserved correctly
- ‚úÖ NAMESPACES.md provides full namespace guidance for LLM agents
- ‚úÖ Uses standard Jinja2 delimiters (industry best practice)

---

## Who Should Upgrade?

### ‚úÖ UPGRADE NOW

**All adopters** should upgrade to v2.0.8:

- **v2.0.7 adopters**: Template was broken in v2.0.7, v2.0.8 fixes it
- **v1.9.3 adopters**: Can now safely upgrade to v2.x (skip v2.0.0-v2.0.7)
- **New projects**: Generate with v2.0.8 for working template

### ‚è∏Ô∏è WAIT

**No reason to wait** - This is a pure bug fix release with no breaking changes.

---

## Prerequisites

- **Current version**: v2.0.7 or v1.9.3
- **Copier version**: 9.4.0+ (recommended 9.10.3)
- **Git status**: Clean working directory (commit or stash changes)
- **Backup**: `git branch backup-v2.0.7` (safety net)

---

## Upgrade Steps

### Step 1: Update Template

```bash
# From your project root
copier update --vcs-ref v2.0.8

# Copier will prompt for any new variables
# Accept defaults or customize as needed
```

### Step 2: Review Changes

```bash
# View all changes
git diff

# Key changes to expect:
# - copier.yml: Updated _envops (standard delimiters)
# - template/NAMESPACES.md: New static file
# - template/scripts/*.sh.jinja: Shell syntax fixes
# - template/scripts/extract_tests.py.jinja: Raw block wrapper
# - template/.github/workflows/dependabot-automerge.yml.jinja: Shell syntax
# - template/pyproject.toml.jinja: TOML syntax
```

### Step 3: Commit Upgrade

```bash
git add .
git commit -m "chore: Upgrade chora-base v2.0.7 ‚Üí v2.0.8 (template bug fix)

- Fixed shell/Python/TOML/YAML syntax preservation
- Added static NAMESPACES.md (Copier bug workaround)
- All template files now generate correctly

ü§ñ Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>"
```

---

## Verification

### Test Template Generation

```bash
# Generate a test project to verify template works
rm -rf /tmp/test-v2.0.8
copier copy --force --trust --vcs-ref v2.0.8 \
  --data project_type=mcp_server \
  --data project_name=test-v208 \
  . /tmp/test-v2.0.8

# Expected result: ‚úÖ SUCCESS (all files generated)
```

### Check Key Files

```bash
# NAMESPACES.md should exist as static file
ls -lh /tmp/test-v2.0.8/template/NAMESPACES.md

# Shell scripts should have correct heredoc syntax
grep -n "<<EOF" /tmp/test-v2.0.8/template/scripts/handoff.sh

# TOML should have correct array syntax
grep -n "\[\[tool.mypy" /tmp/test-v2.0.8/template/pyproject.toml
```

---

## What's Fixed in v2.0.8

### 1. NAMESPACES.md (Copier Bug Workaround)

**Problem**: NAMESPACES.md.jinja triggered Copier bug regardless of delimiter choice

**Solution**: Created static `template/NAMESPACES.md` (no .jinja extension)

**Impact**: Full namespace guidance for LLM agents without rendering errors

```bash
# Old (v2.0.7)
template/NAMESPACES.md.jinja  # ‚ùå Copier rendering error

# New (v2.0.8)
template/NAMESPACES.md        # ‚úÖ Static file, always works
```

### 2. Shell Scripts (15+ Files)

**Problem**: Migration script corrupted shell syntax

**Files Fixed**:
- Heredocs: `<<EOF` was converted to `{{EOF` (6 files)
- Here-strings: `<<<` was converted to `{{<` (2 files)
- Test expressions: `[[ condition ]]` was converted to `{{ condition }}` (9+ files)

**Solution**: Surgical fixes to restore shell syntax

```bash
# Example: bump-version.sh.jinja
# Old (v2.0.7 - BROKEN)
IFS='.' read -r MAJOR MINOR PATCH {{< "$CURRENT_VERSION"

# New (v2.0.8 - FIXED)
IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"
```

### 3. Python Files (1 File)

**Problem**: Embedded bash template with `{{` for function syntax

**Solution**: Wrapped in `{% raw %}...{% endraw %}` block

```python
# extract_tests.py.jinja
# Old (v2.0.7 - BROKEN)
bash_test = '''
test_example() {{
    echo "test"
}}
'''

# New (v2.0.8 - FIXED)
{% raw %}bash_test = '''
test_example() {{
    echo "test"
}}
'''{% endraw %}
```

### 4. TOML Files (1 File)

**Problem**: Array of tables syntax corrupted

**Solution**: Fixed TOML section headers

```toml
# pyproject.toml.jinja
# Old (v2.0.7 - BROKEN)
{{tool.mypy.overrides}}

# New (v2.0.8 - FIXED)
[[tool.mypy.overrides]]
```

### 5. GitHub Actions (1 File)

**Problem**: Mixed `${{ }}` syntax with mangled shell syntax

**Solution**: Fixed shell test expressions and redirects

```yaml
# dependabot-automerge.yml.jinja
# Old (v2.0.7 - BROKEN)
if [[ "$UPDATE_TYPE" == "version-update:semver-minor" }} || {{ "$UPDATE_TYPE" == "version-update:semver-patch" ]]; then
  echo "auto_merge=true" }} $GITHUB_OUTPUT
fi

# New (v2.0.8 - FIXED)
if [[ "$UPDATE_TYPE" == "version-update:semver-minor" ]] || [[ "$UPDATE_TYPE" == "version-update:semver-patch" ]]; then
  echo "auto_merge=true" >> $GITHUB_OUTPUT
fi
```

---

## Troubleshooting

### Issue: "NAMESPACES.md.jinja still exists"

**Symptom**: Both NAMESPACES.md and NAMESPACES.md.jinja present

**Solution**:
```bash
# Remove .jinja version if present
rm template/NAMESPACES.md.jinja
git add template/NAMESPACES.md.jinja
git commit -m "chore: Remove NAMESPACES.md.jinja (using static version)"
```

### Issue: "Template generation still fails"

**Symptom**: Copier errors during template generation

**Solution**:
```bash
# Verify you're using v2.0.8
git tag --list | grep v2.0.8

# Clean copier cache
rm -rf ~/.cache/copier/

# Retry template generation
copier copy --force --trust --vcs-ref=v2.0.8 \
  --data project_type=mcp_server \
  --data project_name=test \
  . /tmp/test
```

### Issue: "Shell scripts have syntax errors"

**Symptom**: `bash: syntax error near unexpected token`

**Solution**:
```bash
# Check for remaining {{ or }} in shell scripts
grep -n "{{" template/scripts/*.sh.jinja
grep -n "}}" template/scripts/*.sh.jinja

# If found, those are Jinja2 variables and should remain
# Only shell syntax (heredocs, here-strings, tests) should be fixed
```

---

## Rollback Procedure

If upgrade causes issues:

```bash
# Restore from backup branch
git checkout backup-v2.0.7
git branch -D main  # Or your branch name
git checkout -b main

# Or revert commit
git revert HEAD
git push
```

---

## Post-Upgrade Tasks

### ‚úÖ Recommended

1. **Test template generation** - Verify template works with your customizations
2. **Update CI** - Ensure GitHub Actions workflows still pass
3. **Document upgrade** - Note upgrade in your project's CHANGELOG

### ‚è≠Ô∏è Optional

1. **Customize NAMESPACES.md** - Update placeholders with your project info
2. **Review delimiter usage** - Ensure any custom templates use standard delimiters

---

## FAQ

**Q: Do I need to update my project's code?**

**A:** No. This is a template-only fix. Your generated project code is unchanged.

---

**Q: What if I'm still on v1.9.3?**

**A:** You can safely upgrade directly to v2.0.8. Skip v2.0.0-v2.0.7 entirely.

```bash
copier update --vcs-ref v2.0.8
```

---

**Q: Will this fix affect my custom templates?**

**A:** Only if your custom templates use shell/Python/TOML/YAML syntax with curly braces. Review changes carefully.

---

**Q: Why did v2.0.7 break the template?**

**A:** The migration script was too aggressive and converted legitimate shell/Python/TOML/YAML syntax (heredocs, test expressions, array syntax) into Jinja2 template syntax. v2.0.8 surgically fixes these issues while keeping standard delimiters.

---

**Q: Is the NAMESPACES.md.jinja bug fixed?**

**A:** No, the Copier bug persists. The workaround (static NAMESPACES.md) is the recommended solution until Copier is updated.

---

## Summary

v2.0.8 completes the migration to standard Jinja2 delimiters by preserving shell/Python/TOML/YAML syntax. All adopters should upgrade immediately.

**Time to upgrade:** 5-10 minutes
**Complexity:** LOW (copier update + review)
**Benefit:** Working template with industry-standard delimiters

---

## Need Help?

- **Template issues**: [chora-base issues](https://github.com/liminalcommons/chora-base/issues)
- **Upgrade questions**: See [docs/upgrades/README.md](README.md)
- **Community**: [Discussions](https://github.com/liminalcommons/chora-base/discussions)

# Upgrade Guide: chora-base v2.0.3 → v2.0.4

**Purpose**: Complete f-string audit - fixes 6 additional template files

---

## Quick Assessment

| Attribute | Value |
|-----------|-------|
| **Upgrade Effort** | <1 min |
| **Displacement Risk** | ZERO (bug fix only) |
| **Breaking Changes** | None |
| **Required Actions** | Run `copier update --vcs-ref v2.0.4` |
| **Critical** | YES (fixes broken regex in MCP module) |

**TL;DR**: v2.0.3 only fixed 1 of 7 files. v2.0.4 fixes the remaining 6 files (73 f-strings), including a critical bug in MCP namespace validation.

---

## What Was Wrong with v2.0.3

v2.0.3 only fixed `scripts/extract_tests.py.jinja` but missed 6 other files with the same f-string/Jinja2 conflict.

### Complete Scope

**Total**: 89 f-strings across 7 template files
- v2.0.3: Fixed 1 file (16 f-strings)
- v2.0.4: Fixed 6 files (73 f-strings)

---

## Files Fixed in v2.0.4

1. ✅ `scripts/validate_docs.py.jinja` (29 f-strings)
2. ✅ `scripts/validate_mcp_names.py.jinja` (22 f-strings)
3. ✅ `src/{{package_name}}/mcp/__init__.py.jinja` (15 f-strings) - **CRITICAL BUG**
4. ✅ `src/{{package_name}}/mcp/server.py.jinja` (5 f-strings)
5. ✅ `src/{{package_name}}/memory/trace.py.jinja` (1 f-string)
6. ✅ `justfile.jinja` (1 f-string)

---

## Critical Bug Fixed

**File**: `src/{{package_name}}/mcp/__init__.py.jinja:184`

```python
# BEFORE (v2.0.3) - BROKEN
f"Pattern: [a-z][a-z0-9]{{2,19}}"
# Jinja2 interprets {{2,19}} as a tuple variable
# Renders as: "Pattern: [a-z][a-z0-9](2, 19)"
# Result: INVALID REGEX!

# AFTER (v2.0.4) - FIXED
{% raw %}"Pattern: [a-z][a-z0-9]{2,19}".format(){% endraw %}
# Renders as: "Pattern: [a-z][a-z0-9]{2,19}"
# Result: Valid regex pattern
```

**Impact**: MCP namespace validation was broken - regex pattern was invalid.

---

## Upgrade Steps

```bash
# 1. Ensure clean working tree
git status

# 2. Upgrade to v2.0.4
copier update --vcs-ref v2.0.4

# 3. No conflicts expected

# 4. Commit
git add -A
git commit -m "chore: Upgrade to chora-base v2.0.4 (complete f-string audit)"
```

---

## Verification

```bash
# Check that MCP validation works
python3 -c "from src.YOUR_PKG.mcp import validate_namespace; validate_namespace('test123')"

# Should work without regex errors
```

---

## Who Needs This Upgrade

- **Critical** if you use MCP features (namespace validation broken in v2.0.3)
- **Recommended** for all projects to ensure template integrity

---

## FAQ

**Q: Why didn't v2.0.3 fix all files?**

A: We only audited scripts/extract_tests.py.jinja (the file with the reported error). v2.0.4 includes a comprehensive audit of ALL 20 .jinja files in the template.

**Q: How do I know v2.0.4 is complete?**

A:
- Audited all 20 .jinja files
- Tested each for Jinja2 syntax + f-strings
- Zero f-strings remain in any code .jinja file
- All files compile successfully with Jinja2

**Q: Will there be a v2.0.5?**

A: No - this is the complete fix. All template files verified.

---

**Questions?** See [GitHub issue #1](https://github.com/liminalcommons/chora-base/issues/1)

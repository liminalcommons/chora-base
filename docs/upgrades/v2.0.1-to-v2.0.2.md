# Upgrade Guide: chora-base v2.0.1 → v2.0.2

**Purpose**: Complete template syntax fix for extract_tests.py.jinja

---

## Quick Assessment

| Attribute | Value |
|-----------|-------|
| **Upgrade Effort** | <5 min |
| **Displacement Risk** | ZERO (bug fix only) |
| **Breaking Changes** | None |
| **Required Actions** | Run `copier update --vcs-ref v2.0.2` |
| **Skip if** | Not using v2.0.0 or v2.0.1, or not using documentation features |

**TL;DR**: v2.0.1's template fix was incomplete. v2.0.2 completes the fix by wrapping one additional f-string that was missed. All adopters on v2.0.0 or v2.0.1 should upgrade.

---

## Decision Tree for AI Agents

```
START
├─ Currently on v2.0.0 or v2.0.1?
│  ├─ NO → Check other upgrade guides
│  └─ YES → Continue evaluation
│
├─ Does `copier update` fail with TemplateSyntaxError?
│  ├─ YES → **UPGRADE REQUIRED** (fixes your issue)
│  └─ NO → **UPGRADE RECOMMENDED** (prevents future issues)
│
└─ END: Run `copier update --vcs-ref v2.0.2`
```

**Recommendation**: **UPGRADE** - This is a pure bug fix with zero displacement risk.

---

## What Changed

**Single File Modified**:

| File | Changes | Lines |
|------|---------|-------|
| template/scripts/extract_tests.py.jinja | Wrapped one additional f-string in `{% raw %}{% endraw %}` blocks | +2 |

**Change Details**:

```python
# Before (v2.0.1) - Line 425
                content += f'''
if {test_name}; then
    echo -e "${{GREEN}}✓${{NC}} {test_name}"
    ((TESTS_PASSED++))
else
    echo -e "${{RED}}✗${{NC}} {test_name}"
    ((TESTS_FAILED++))
fi
((TESTS_RUN++))
'''

# After (v2.0.2) - Lines 425-434
{% raw %}                content += f'''
if {test_name}; then
    echo -e "${{GREEN}}✓${{NC}} {test_name}"
    ((TESTS_PASSED++))
else
    echo -e "${{RED}}✗${{NC}} {test_name}"
    ((TESTS_FAILED++))
fi
((TESTS_RUN++))
'''{% endraw %}
```

**Why This Matters**:
- v2.0.1 fixed 4 f-string sections but missed the 5th at line 425
- Python f-strings use `{}` for interpolation, which Jinja2 also uses for variables
- Without `{% raw %}` blocks, Jinja2 tries to interpret `{test_name}` as a template variable
- This causes `TemplateSyntaxError: unexpected char '#' at 9814` during project generation

**All Protected F-Strings (v2.0.2)**:
- Lines 176-204: Fixture + async test generation ✅
- Lines 227-254: Parameterized + regular test generation ✅
- Lines 291-313: Bash test generation ✅
- Lines 341-359: Header generation ✅
- **Lines 425-434: Bash test runner generation ✅ (NEW in v2.0.2)**

---

## Upgrade Steps

### Prerequisites

- ✅ Currently on v2.0.0 or v2.0.1
- ✅ All changes committed to git
- ✅ Working directory clean (`git status`)

### Execution

```bash
# 1. Upgrade to v2.0.2
copier update --vcs-ref v2.0.2

# 2. No conflicts expected (bug fix only)
# If copier asks about any files, accept template version

# 3. Verify the fix
python3 -c "from jinja2 import Template; Template(open('scripts/extract_tests.py').read()); print('✅ Template syntax correct')"

# 4. Commit
git add -A
git commit -m "chore: Upgrade to chora-base v2.0.2 (complete template fix)"
```

---

## Validation Checklist

- [ ] Template generation completes without TemplateSyntaxError
- [ ] `scripts/extract_tests.py` exists and is valid Python
- [ ] No Jinja2 syntax remaining in generated files (`grep -r "{% " . --exclude-dir=.git`)
- [ ] Tests pass: `pytest`
- [ ] Pre-commit hooks pass: `pre-commit run --all-files`

---

## Rollback Procedure

If you need to rollback (unlikely for a bug fix):

```bash
# Rollback to v2.0.1 (not recommended, has bug)
copier update --vcs-ref v2.0.1

# OR rollback to v1.9.3 (last stable before v2.0.0)
copier update --vcs-ref v1.9.3
```

**Note**: v2.0.1 has the same bug, so rolling back to it doesn't help. If you encounter issues, rollback to v1.9.3.

---

## Common Issues

### Issue: "Still getting TemplateSyntaxError after v2.0.2"

**Symptoms**: `copier update --vcs-ref v2.0.2` fails with template syntax error

**Cause**: Copier cache or GitHub CDN cache serving stale template

**Solution**:
```bash
# Clear copier cache
rm -rf ~/.cache/copier/

# Force copier to re-fetch template
copier update --vcs-ref v2.0.2 --force
```

### Issue: "Generated extract_tests.py has {% raw %} in it"

**Symptoms**: Generated Python file contains literal `{% raw %}` text

**Cause**: Template file not being processed correctly (shouldn't happen)

**Solution**:
```bash
# This is a template processing bug - report to chora-base
# Workaround: Manually remove {% raw %}/{% endraw %} from generated file
sed -i '' '/{% raw %}\|{% endraw %}/d' scripts/extract_tests.py
```

---

## FAQ

**Q: Do I need to upgrade if I'm on v1.9.3?**

A: Not urgently. v1.9.3 is stable. Upgrade to v2.0.2 when you want the nested AGENTS.md architecture (v2.0.0 feature). Skip v2.0.0 and v2.0.1 entirely - go straight to v2.0.2.

**Q: What if I'm on v2.0.0?**

A: Definitely upgrade. v2.0.0 has the template syntax bug. v2.0.2 fixes it completely.

**Q: What if I'm on v2.0.1?**

A: Yes, upgrade. v2.0.1's fix was incomplete (4 out of 5 f-strings fixed). v2.0.2 completes the fix.

**Q: Can I skip v2.0.1 and v2.0.2 and upgrade to the next version?**

A: Yes! The fix is cumulative - any version after v2.0.2 will include this fix.

**Q: Why did v2.0.1 miss this f-string?**

A: The f-string at line 425 was inside a `for` loop in `_generate_bash_test_file()`, making it less obvious during manual review. We've now added automated template syntax validation to prevent this in the future.

---

## For AI Agents: Decision Documentation

After completing this upgrade, document the decision:

**Knowledge Note Template**:
```json
{
  "timestamp": "2025-10-22T15:30:00Z",
  "event": "upgrade_chora_base_v2.0.1_to_v2.0.2",
  "decision": {
    "action": "upgrade",
    "from_version": "v2.0.1",
    "to_version": "v2.0.2",
    "rationale": "Bug fix - v2.0.1 template syntax fix was incomplete",
    "outcome": "successful",
    "issues_encountered": []
  },
  "upgrade_stats": {
    "files_changed": 1,
    "lines_added": 2,
    "conflicts": 0,
    "time_minutes": 2,
    "displacement_risk": "ZERO"
  },
  "validation": {
    "template_syntax_valid": true,
    "tests_pass": true,
    "pre_commit_pass": true
  }
}
```

---

**Questions?** See [PHILOSOPHY.md](PHILOSOPHY.md) or open a GitHub issue.

**Thank you to the mcp-n8n team** for reporting this issue and helping us deliver a complete fix.

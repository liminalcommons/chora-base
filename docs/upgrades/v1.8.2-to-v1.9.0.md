# Upgrade Guide: v1.8.2 → v1.9.0

**Upgrade Type:** Minor (new feature, opt-in)
**Upgrade Difficulty:** Easy
**Estimated Time:** 10-20 minutes

---

## What's New in v1.9.0

### Docker Support - Production-Ready Containerization

v1.9.0 introduces comprehensive Docker support to eliminate CI environment issues, enable production deployment, and provide microservices orchestration.

**New Features:**
- ✅ Multi-stage production Dockerfile (builder + runtime)
- ✅ CI-focused Dockerfile.test (isolated testing environment)
- ✅ Optimized .dockerignore (build performance)
- ✅ docker-compose.yml orchestration (microservices ready)
- ✅ Justfile Docker commands (`just docker-*`)
- ✅ Security best practices (non-root user, health checks)

**Who Should Upgrade:**
- **Projects with CI issues**: Docker solves system vs pip package conflicts
- **Production deployments**: MCP servers, web services need containerization
- **Microservices architecture**: Orchestrate multiple services with docker-compose
- **All projects**: Docker is opt-in (disabled by default)

---

## Before You Start

### Prerequisites

1. **Clean Git State**
   ```bash
   git status  # Should show "nothing to commit, working tree clean"
   ```

2. **Docker Installed (if testing)**
   ```bash
   docker --version  # Optional, only if you'll enable Docker
   ```

3. **Review Current State**
   ```bash
   # Check if you already have Docker files
   ls Dockerfile* docker-compose.yml .dockerignore 2>/dev/null
   ```

### Decision Tree

**Question 1: Do you need Docker support?**
- **CI Isolation**: GitHub Actions has package version conflicts? → **YES** (use `ci-only` strategy)
- **Production Deployment**: Deploy to servers/cloud? → **YES** (use `production` strategy)
- **Microservices**: Multiple services (n8n + MCP gateway + backends)? → **YES** (use `production`)
- **Local Development Only**: Just using venv? → **MAYBE** (Docker helps with "works on my machine" issues)
- **Library Project**: Not deploying containers? → **PROBABLY NO**

**Question 2: Which Docker strategy?**
- **production**: Multi-stage Dockerfile + docker-compose (full deployment stack)
- **ci-only**: Just Dockerfile.test for CI testing (minimal footprint)

---

## Quick Upgrade (Non-Docker Users)

If you don't need Docker (most library projects, local-only development):

```bash
# 1. Update template
copier update --vcs-ref=v1.9.0

# 2. Review changes (should be minimal)
git diff

# 3. Keep relevant changes
git add CHANGELOG.md docs/
git commit -m "chore: Upgrade chora-base to v1.9.0 (no Docker)"

# Done!
```

**Expected changes:**
- Updated documentation (Docker guides added)
- Updated CHANGELOG.md
- No Docker files generated (include_docker still false)

---

## Upgrade Path: Enable Docker

### Option A: copier Update (Recommended for New Adoption)

```bash
# 1. Update from v1.9.0
copier update --vcs-ref=v1.9.0

# Answer new prompts:
# include_docker: true
# docker_strategy: production  # or ci-only

# 2. Review generated files
git status
# Expected new files:
# - Dockerfile
# - Dockerfile.test
# - .dockerignore
# - docker-compose.yml (if production strategy)

# 3. Review changes
git diff

# 4. Commit
git add Dockerfile* .dockerignore docker-compose.yml justfile
git commit -m "feat(docker): Enable Docker support from chora-base v1.9.0"
```

### Option B: Manual Adoption (For Existing Projects with Customizations)

**Step 1: Add Docker Files**

```bash
# Option 1: Use copier update selectively
copier update --vcs-ref=v1.9.0
# Answer: include_docker: true, docker_strategy: production

# Review and cherry-pick
git add -p  # Interactive staging

# Option 2: Copy templates manually
# Clone chora-base, copy template files, replace variables
```

**Step 2: Customize for Your Project**

```bash
# Edit Dockerfile if needed (adjust base image, dependencies)
# Edit docker-compose.yml if needed (add services, volumes)
# Edit .dockerignore if needed (project-specific exclusions)
```

**Step 3: Update justfile**

The template adds Docker commands to justfile. If you have a custom justfile:

```bash
# Compare template justfile with yours
diff justfile template/justfile.jinja

# Manually add Docker commands section (lines 186-263 in template)
# Or use copier merge and resolve conflicts
```

---

## Testing Docker Setup

### Step 1: Build Test Image

```bash
# Build CI/test Docker image
just docker-build-test
# or: docker build -t my-project:test -f Dockerfile.test .

# Expected output:
# Successfully built...
# Successfully tagged my-project:test
```

### Step 2: Run Tests in Docker

```bash
# Run tests in isolated environment
just docker-test
# or: docker run --rm my-project:test

# Expected output:
# ✓ Tests pass in Docker
# ✓ Coverage meets threshold
# ✓ No system package conflicts
```

### Step 3: Build Production Image (if using production strategy)

```bash
# Build multi-stage production image
just docker-build
# or: docker build -t my-project:latest .

# Verify image size (should be ~100-200MB)
docker images my-project:latest
```

### Step 4: Test docker-compose (if using production strategy)

```bash
# Start services
just docker-compose-up
# or: docker-compose up -d

# Verify services running
docker-compose ps

# Check logs
just docker-logs
# or: docker-compose logs -f

# Stop services
just docker-compose-down
```

---

## CI Integration (GitHub Actions)

### Update Workflow to Use Docker

**Before (system pip):**
```yaml
# .github/workflows/test.yml
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - run: pip install -e ".[dev]"
      - run: pytest  # May have version conflicts
```

**After (Docker isolation):**
```yaml
# .github/workflows/test.yml
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build test image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.test
          push: false
          load: true
          tags: my-project:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Run tests in Docker
        run: docker run --rm my-project:test
```

**Benefits:**
- ✅ Guaranteed isolation (no system package conflicts)
- ✅ Faster CI (Docker layer caching)
- ✅ Reproducible environment
- ✅ Same environment as production (if using production strategy)

---

## Production Deployment

### Deploy MCP Server with Docker

```bash
# 1. Build production image
docker build -t my-mcp-server:1.0.0 .

# 2. Run with docker-compose
docker-compose up -d

# 3. Verify health
docker-compose ps
docker-compose logs -f my-mcp-server

# 4. Monitor
docker stats  # Resource usage
docker logs my-mcp-server --follow  # Logs
```

### Environment Variables

Create `.env` file:

```bash
# Application settings
MY_PROJECT_LOG_LEVEL=INFO

# API keys (for MCP servers)
ANTHROPIC_API_KEY=sk-ant-...
CODA_API_KEY=...

# Database (if applicable)
DATABASE_URL=postgresql://...
```

Mount as read-only volume:

```yaml
# docker-compose.yml
services:
  my-project:
    env_file:
      - .env  # or mount as volume: -v .env:/app/.env:ro
```

---

## Verification Checklist

After upgrading, verify:

- [ ] `include_docker` option set in `.copier-answers.yml`
- [ ] `docker_strategy` option set (production or ci-only)
- [ ] Docker files exist:
  - [ ] `Dockerfile` (if production)
  - [ ] `Dockerfile.test`
  - [ ] `.dockerignore`
  - [ ] `docker-compose.yml` (if production)
- [ ] Justfile has Docker commands section
- [ ] `just docker-build-test` succeeds
- [ ] `just docker-test` passes
- [ ] `just docker-build` succeeds (if production)
- [ ] `just docker-compose-up` starts services (if production)

---

## Troubleshooting

### Issue: docker-build fails with "No such file or directory"

**Symptom:**
```
Step 3/10 : COPY pyproject.toml README.md ./
COPY failed: file not found in build context
```

**Cause:** Files excluded by .dockerignore or wrong build context.

**Solution:**
```bash
# Verify .dockerignore doesn't exclude required files
cat .dockerignore | grep -E "pyproject|README"

# Build from correct directory
docker build -t my-project:latest .  # ← Current directory
```

### Issue: justfile Docker commands not found

**Symptom:**
```bash
$ just docker-build
error: Justfile does not contain recipe `docker-build`
```

**Cause:** Justfile not updated with Docker commands.

**Solution:**
```bash
# Option 1: Re-run copier update (merge justfile changes)
copier update --vcs-ref=v1.9.0

# Option 2: Manually add Docker commands section
# Copy lines 186-263 from template/justfile.jinja
```

### Issue: docker-compose services can't communicate

**Symptom:**
```
Connection refused when calling http://service-a:8000
```

**Cause:** Services not on same network.

**Solution:**
```yaml
# docker-compose.yml
services:
  service-a:
    networks:
      - my-network
  service-b:
    networks:
      - my-network

networks:
  my-network:
    driver: bridge
```

---

## Benefits After Upgrade

✅ **CI Isolation**: No more system vs pip package conflicts
✅ **Production Ready**: Multi-stage builds, security hardening
✅ **Microservices**: docker-compose orchestration ready
✅ **Developer Experience**: `just docker-*` commands
✅ **Ecosystem Consistency**: Same Docker patterns across chora-base projects

---

## Rollback Procedure

If you need to revert:

```bash
# 1. Remove Docker files
git rm Dockerfile* .dockerignore docker-compose.yml

# 2. Revert justfile changes
git checkout HEAD~1 justfile

# 3. Update .copier-answers.yml
# Set: include_docker: false

# 4. Commit rollback
git commit -m "revert: Remove Docker support (temporary)"
```

---

## Additional Notes

### Docker Strategy Comparison

| Feature | production | ci-only |
|---------|-----------|---------|
| Dockerfile | ✅ Multi-stage | ❌ |
| Dockerfile.test | ✅ | ✅ |
| .dockerignore | ✅ | ✅ |
| docker-compose.yml | ✅ | ❌ |
| Production deployment | ✅ | ❌ |
| CI testing | ✅ | ✅ |
| File count | 4 files | 2 files |

**Choose production if:**
- Deploying to servers/cloud
- Need microservices orchestration
- Want full Docker stack

**Choose ci-only if:**
- Only need CI isolation
- No production deployment planned
- Want minimal Docker footprint

### Performance Notes

**Build times:**
- First build: ~2-3 minutes (download base image, install dependencies)
- Subsequent builds: ~30 seconds (layer caching)
- CI with GitHub Actions cache: ~45 seconds

**Image sizes:**
- Multi-stage production: ~100-150MB
- Test image: ~200-250MB (includes dev dependencies)
- Base python:3.12-slim: ~50MB

---

## References

- [Docker Deployment Guide](../how-to/03-docker-deployment.md) - Comprehensive guide
- [chora-base v1.9.0 CHANGELOG](../../CHANGELOG.md#190---2025-10-21) - Full release notes
- [mcp-n8n Docker Implementation](https://github.com/liminalcommons/mcp-n8n) - Original use case
- [Docker Best Practices](https://docs.docker.com/develop/dev-best-practices/) - Official Docker docs

---

## Questions?

If you encounter issues not covered in this guide:

1. Check [Docker Deployment Guide](../how-to/03-docker-deployment.md)
2. Review [mcp-n8n Docker setup](https://github.com/liminalcommons/mcp-n8n) for real-world example
3. Open an issue at [chora-base/issues](https://github.com/liminalcommons/chora-base/issues)

**Upgrade completed successfully?** 🎉

Next: Consider enabling Docker for CI isolation or production deployment!

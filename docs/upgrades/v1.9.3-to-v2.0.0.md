# Upgrading from v1.9.3 to v2.0.0

**Upgrade Effort**: <10 minutes (template update only)
**Breaking Changes**: Yes - AGENTS.md structure changed
**Required For**: Improved agent discoverability, reduced cognitive load
**Displacement Risk**: ZERO for custom code (documentation-only change)

**Version Bump**: MAJOR (v1.9.3 → v2.0.0)
**Reason for MAJOR**: Breaking architectural change to AGENTS.md structure

---

## TL;DR

v2.0.0 refactors monolithic AGENTS.md into **nested, topic-specific guides**:
- Main AGENTS.md reduced from 2,539 → 1,239 lines (51% reduction)
- Testing guide → `tests/AGENTS.md`
- Memory system → `.chora/memory/AGENTS.md`
- Docker operations → `docker/AGENTS.md`
- Scripts reference → `scripts/AGENTS.md`

**"Nearest file wins"** principle: Agents read the AGENTS.md closest to the code they're working on.

**Impact on adopters**: Minimal (template update merges cleanly, no code changes)

---

## Decision Tree for AI Agents

```
START
├─ Does project use AGENTS.md?
│  ├─ NO → Skip upgrade (not relevant)
│  └─ YES → Continue evaluation
├─ Has AGENTS.md been customized?
│  ├─ NO → Upgrade (merge is trivial)
│  └─ YES → Continue evaluation
├─ Are customizations in extracted sections?
│  │  (Testing, Memory, Docker, Scripts)
│  ├─ YES → Manual merge required (review conflicts)
│  └─ NO → Upgrade (merge is clean)
END
```

**Recommendation**: Upgrade. Benefits outweigh costs for all adopters.

---

## What Changed

### Files Changed/Added

1. **`AGENTS.md`** (modified)
   - Lines: 2,539 → 1,239 (51% reduction)
   - Added discovery index ("Documentation Structure" section)
   - Removed: Testing, Memory, Docker sections (extracted)
   - Kept: Overview, PR instructions, architecture, common tasks

2. **`tests/AGENTS.md`** (new)
   - ~330 lines
   - Testing instructions, coverage, linting, super-tests
   - Troubleshooting (test failures, type errors)

3. **`.chora/memory/AGENTS.md`** (new, conditional)
   - ~620 lines
   - 3-tier architecture, event log, knowledge graph
   - Advanced query patterns, A-MEM workflow
   - Only generated if `include_memory_system: true`

4. **`docker/AGENTS.md`** (new, conditional)
   - ~90 lines
   - Docker operations, workflows, image optimization
   - Only generated if `include_docker: true`

5. **`scripts/AGENTS.md`** (new)
   - ~260 lines
   - Automation scripts reference, justfile tasks
   - Always generated

### Template Changes

**copier.yml**:
```yaml
_exclude:
  # v2.0.0: Nested AGENTS.md files (exclude if feature not enabled)
  - "{% if not include_tests %}tests/AGENTS.md.jinja{% endif %}"
  - "{% if not include_memory_system %}.chora/memory/AGENTS.md.jinja{% endif %}"
  - "{% if not include_docker %}docker/AGENTS.md.jinja{% endif %}"
```

---

## Displacement Analysis

### Type 1: Required Displacement (None)

No required changes. This is documentation architecture only.

### Type 2: Optional Displacement (AGENTS.md structure)

**Old Pattern**: Single monolithic AGENTS.md (2,539 lines)
**New Pattern**: Nested topic-specific AGENTS.md files

**Adoption Decision**:
- ✅ **Adopt** if you want improved agent discoverability
- ✅ **Adopt** if AGENTS.md feels overwhelming
- ⚠️ **Defer** if you've heavily customized AGENTS.md and need time to migrate

### Type 3: Additive (New Files)

New files added:
- `tests/AGENTS.md` - Pure addition (no conflict)
- `.chora/memory/AGENTS.md` - Pure addition (conditional)
- `docker/AGENTS.md` - Pure addition (conditional)
- `scripts/AGENTS.md` - Pure addition (no conflict)

---

## Upgrade Steps

### Prerequisites

1. **Clean git state**:
   ```bash
   git status
   # Should show "nothing to commit, working tree clean"
   ```

2. **Backup current AGENTS.md** (if customized):
   ```bash
   cp AGENTS.md AGENTS.md.backup
   ```

### Execution

```bash
# 1. Update template
copier update --vcs-ref v2.0.0

# You will see:
# - Conflict in AGENTS.md (if customized)
# - New files: tests/AGENTS.md, scripts/AGENTS.md
# - New files (conditional): .chora/memory/AGENTS.md, docker/AGENTS.md

# 2. Review changes
git diff

# 3. Resolve conflicts (if any)
# See "Conflict Resolution" section below

# 4. Test that AGENTS.md files are discoverable
cat AGENTS.md | head -50
# Should show "Documentation Structure (Nearest File Wins)" section

# 5. Commit upgrade
git add -A
git commit -m "chore: Upgrade chora-base v1.9.3 → v2.0.0 (nested AGENTS.md)"
```

---

## Conflict Resolution

### Conflict 1: Custom Testing Instructions in AGENTS.md

**Scenario**: You added custom testing commands to main AGENTS.md

**Resolution**:
1. Find your custom content in `AGENTS.md.backup`
2. Paste into new `tests/AGENTS.md` in appropriate section
3. Remove from main `AGENTS.md`

**Example**:
```bash
# Extract custom testing commands
grep -A 10 "Custom Test Commands" AGENTS.md.backup > custom_tests.txt

# Add to tests/AGENTS.md
echo "\n## Custom Test Commands\n" >> tests/AGENTS.md
cat custom_tests.txt >> tests/AGENTS.md
rm custom_tests.txt
```

### Conflict 2: Custom Memory System Documentation

**Scenario**: You documented custom memory queries in AGENTS.md

**Resolution**:
1. Extract custom memory content from `AGENTS.md.backup`
2. Append to `.chora/memory/AGENTS.md`
3. Link from main AGENTS.md if needed

### Conflict 3: Custom Docker Commands

**Scenario**: You added project-specific Docker workflows

**Resolution**:
1. Extract from `AGENTS.md.backup`
2. Append to `docker/AGENTS.md` under "## Custom Workflows"
3. Update discovery index in main AGENTS.md

---

## Testing After Upgrade

### Validation Checklist

- [ ] Main AGENTS.md includes "Documentation Structure (Nearest File Wins)" section
- [ ] `tests/AGENTS.md` exists and contains testing guidance
- [ ] `scripts/AGENTS.md` exists and lists automation scripts
- [ ] `.chora/memory/AGENTS.md` exists if `include_memory_system: true`
- [ ] `docker/AGENTS.md` exists if `include_docker: true`
- [ ] All nested AGENTS.md files have "Parent" link to main AGENTS.md
- [ ] Discovery index in main AGENTS.md links to all nested files
- [ ] Custom content (if any) migrated to appropriate nested file

### Smoke Test

```bash
# Verify nested structure
ls -la AGENTS.md tests/AGENTS.md scripts/AGENTS.md
# All should exist

# Verify discovery index
head -100 AGENTS.md | grep "Nearest File Wins"
# Should match

# Verify links work
grep "\[tests/AGENTS.md\]" AGENTS.md
grep "\[../AGENTS.md\]" tests/AGENTS.md
# Both should match

# Test with AI agent (if available)
# Ask agent: "Where do I find testing instructions?"
# Expected: Agent references tests/AGENTS.md
```

---

## Rollback Procedure

If upgrade causes issues:

```bash
# 1. Restore backup
git log --oneline | head -5
# Find commit before upgrade

# 2. Reset to previous commit
git reset --hard <COMMIT_BEFORE_UPGRADE>

# 3. Verify rollback
cat AGENTS.md | wc -l
# Should be ~2,539 lines (old monolithic structure)

# 4. Alternative: Manual rollback
git checkout v1.9.3 -- AGENTS.md
git rm tests/AGENTS.md .chora/memory/AGENTS.md docker/AGENTS.md scripts/AGENTS.md
git commit -m "Rollback to v1.9.3 AGENTS.md structure"
```

---

## Benefits vs Costs

### Benefits

**Reduced Cognitive Load**:
- Main AGENTS.md: 2,539 → 1,239 lines (51% smaller)
- Agents see only relevant guidance (not entire project docs)

**Improved Discoverability**:
- "Nearest file wins" principle (contextual guidance)
- Clear navigation index (find what you need quickly)
- Topic-specific deep dives (testing, memory, Docker, scripts)

**Better Separation of Concerns**:
- Testing guidance in `tests/` (co-located with tests)
- Memory docs in `.chora/memory/` (co-located with memory system)
- Docker docs in `docker/` (co-located with Dockerfiles)

**Scalable Architecture**:
- Easy to add more nested guides (e.g., `src/AGENTS.md` for code organization)
- No single file becomes overwhelming
- Modular approach follows industry best practices

### Costs

**Migration Effort**:
- <10 minutes for most projects (template update)
- +15-30 minutes if AGENTS.md heavily customized (manual merge)

**Learning Curve**:
- Agents must learn "nearest file wins" principle
- Discovery index helps mitigate this

**Merge Complexity** (if customized AGENTS.md):
- Must identify which custom content goes in which nested file
- One-time cost (future updates merge cleanly)

---

## FAQ

### Q1: Do I need to migrate custom AGENTS.md content?

**Answer**: Only if you've customized sections that moved to nested files.

**Check**:
```bash
diff AGENTS.md.backup AGENTS.md | grep "^<" | head -20
# Shows lines removed from old AGENTS.md
# If these are custom, migrate to nested files
```

### Q2: Will future chora-base updates merge cleanly?

**Answer**: Yes. Nested structure makes merges cleaner (smaller files, less conflict surface area).

### Q3: Can I keep monolithic AGENTS.md?

**Answer**: Not recommended. Template generates nested structure in v2.0.0+. Keeping monolithic AGENTS.md means manually rejecting template updates.

### Q4: What if I don't use Docker/Memory?

**Answer**: Those nested files won't be generated (conditional in copier.yml).

```yaml
# docker/AGENTS.md only generated if:
include_docker: true

# .chora/memory/AGENTS.md only generated if:
include_memory_system: true
```

### Q5: How do agents know which AGENTS.md to read?

**Answer**: "Nearest file wins" principle + discovery index.

**Example**:
- Agent writing tests → Reads `tests/AGENTS.md` (nearest to `tests/`)
- Agent working on memory → Reads `.chora/memory/AGENTS.md`
- Agent doing general work → Reads root `AGENTS.md`, sees discovery index

---

## For AI Agents: Decision Documentation

After completing upgrade, create knowledge note:

```json
{
  "id": "chora-base-v2-nested-agents-md",
  "title": "Upgraded to chora-base v2.0.0 (Nested AGENTS.md)",
  "tags": ["template-upgrade", "documentation", "agents-md"],
  "confidence": "high",
  "content": {
    "decision": "Upgraded to v2.0.0 nested AGENTS.md structure",
    "rationale": "51% reduction in main file, improved discoverability",
    "outcome": "Successful. Agents now read nearest AGENTS.md for contextual guidance",
    "migration_notes": "Custom content moved to tests/AGENTS.md (if applicable)",
    "benefits_realized": [
      "Reduced cognitive load (smaller main file)",
      "Better topic separation (testing, memory, Docker in dedicated files)",
      "Clearer navigation (discovery index)"
    ]
  }
}
```

---

## Related Resources

- **[chora-base v2.0.0 Release Notes](https://github.com/liminalcommons/chora-base/releases/tag/v2.0.0)**
- **[Agentic Coding Best Practices Research](https://github.com/liminalcommons/chora-base/blob/main/docs/research/Agentic%20Coding%20Best%20Practices%20Research.pdf)** - Research backing this change
- **[Upgrade Philosophy](PHILOSOPHY.md)** - Understanding chora-base upgrades

---

**Questions?** Open an issue: https://github.com/liminalcommons/chora-base/issues

**Version**: chora-base v2.0.0 (2025-10-22)

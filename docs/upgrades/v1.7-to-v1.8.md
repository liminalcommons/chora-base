# Upgrade Guide: v1.7.0 → v1.8.0

**Upgrade Type:** Minor (backward compatible for existing projects, new features for MCP servers)
**Upgrade Difficulty:** Easy-Medium (depends on customizations)
**Estimated Time:** 15-30 minutes

---

## What's New in v1.8.0

### Chora MCP Conventions v1.0

v1.8.0 introduces **opinionated, ergonomic, and robust** MCP naming conventions:

**New Features:**
- ✅ Tool namespacing (`myproject:tool_name`)
- ✅ Resource URI scheme (`myproject://type/id`)
- ✅ Runtime validation (pre-commit hooks + validation script)
- ✅ Migration tooling (`scripts/migrate_namespace.sh`)
- ✅ Helper functions (`make_tool_name()`, `make_resource_uri()`)
- ✅ NAMESPACES.md registry template
- ✅ Comprehensive documentation (standards + best practices)

**Who Should Upgrade:**
- **MCP Server projects**: Strongly recommended (ecosystem integration)
- **Other project types**: Optional (no MCP-specific changes)

---

## Before You Start

### Prerequisites

1. **Clean Git State**
   ```bash
   git status  # Should show "nothing to commit, working tree clean"
   ```

2. **Backup Important Customizations**
   ```bash
   # Note any custom changes to:
   # - src/*/server.py (if exists)
   # - pyproject.toml (entry points)
   # - AGENTS.md (MCP-specific sections)
   ```

3. **Review Current State**
   ```bash
   # Check if you have MCP server already
   ls src/*/server.py 2>/dev/null

   # Check current entry point
   grep "project.scripts" pyproject.toml
   ```

### Decision Tree

**Question 1: Is your project an MCP server (`project_type: mcp_server`)?**
- **No** → Skip to [Quick Upgrade (Non-MCP)](#quick-upgrade-non-mcp)
- **Yes** → Continue to Question 2

**Question 2: Do you already have custom MCP tools/resources?**
- **No (new/minimal server)** → Use [Full Upgrade Path](#full-upgrade-path-recommended)
- **Yes (production server)** → Use [Selective Upgrade Path](#selective-upgrade-path)

**Question 3: Will you integrate with mcp-n8n gateway or multi-server ecosystem?**
- **Yes** → Enable namespacing (default)
- **No (standalone)** → Namespacing optional but recommended

---

## Quick Upgrade (Non-MCP)

If your project is NOT an MCP server (library, CLI, web service):

```bash
# 1. Update template
copier update --vcs-ref=v1.8.0

# 2. Review changes
git diff

# 3. Keep relevant changes
git add -A
git commit -m "chore: Upgrade chora-base to v1.8.0"

# Done!
```

**Expected changes:**
- Updated docs/standards/ (new MCP conventions docs)
- Updated docs/reference/ (new best practices)
- Potentially updated AGENTS.md template

No code changes required for non-MCP projects.

---

## Full Upgrade Path (Recommended)

For **new or minimal MCP servers** wanting full v1.8.0 features.

### Step 1: Run Copier Update

```bash
copier update --vcs-ref=v1.8.0
```

### Step 2: Answer MCP Namespace Questions

```
MCP namespace for tools/resources (e.g., 'myproject' → myproject:tool_name)
Default: [myproject]  # Or your project-slug without hyphens
> myproject

Prefix tools with namespace? Recommended for ecosystem integration (myproject:tool_name)
Default: [true]
> true  # Recommended

Generate resource URI helpers? (myproject://type/id)
Default: [true]
> true  # Recommended

Include runtime namespace validation and pre-commit hooks?
Default: [true]
> true  # Recommended
```

**Choosing Your Namespace:**
- Default (recommended): `project-slug` without hyphens
- Custom: 3-20 chars, lowercase alphanumeric only
- Check registry: No collisions with [ecosystem servers](../standards/CHORA_MCP_CONVENTIONS_v1.0.md#ecosystem-registry)

### Step 3: Review Generated Files

```bash
git diff --stat
```

**Expected new files:**
- `src/{package}/mcp/__init__.py` - Namespace utilities
- `src/{package}/mcp/server.py` - MCP server with namespacing
- `NAMESPACES.md` - Namespace registry
- `scripts/validate_mcp_names.py` - Validation script
- `scripts/migrate_namespace.sh` - Migration helper
- `docs/standards/CHORA_MCP_CONVENTIONS_v1.0.md`
- `docs/reference/mcp-naming-best-practices.md`

**Expected changes:**
- `pyproject.toml` - Entry point: `{package}.mcp.server:main`
- `copier.yml` (in answers) - New MCP config options
- `AGENTS.md` - New MCP conventions section

### Step 4: Merge Custom Code (If Any)

If you had existing `src/{package}/server.py`:

```bash
# 1. View your old implementation
git show HEAD:src/{package}/server.py > /tmp/old_server.py

# 2. New location is src/{package}/mcp/server.py
vim src/{package}/mcp/server.py

# 3. Copy your tool implementations
# Replace example_tool/hello_world with your actual tools

# 4. Use helper functions for naming
# Example:
#   Old: "my_tool"
#   New: make_tool_name("my_tool")  # → "myproject:my_tool"
```

### Step 5: Update Tests (If Any)

```bash
# Update test fixtures to use namespaced names
# Example:
#   Old: await client.call_tool("create_task", {...})
#   New: await client.call_tool("myproject:create_task", {...})

vim tests/test_*.py
```

### Step 6: Validate

```bash
# 1. Validate naming conventions
python scripts/validate_mcp_names.py

# 2. Run tests
pytest

# 3. Smoke test
./scripts/smoke-test.sh
```

### Step 7: Update Documentation

```bash
# 1. Update NAMESPACES.md with your tools/resources
vim NAMESPACES.md

# 2. Update README.md with MCP examples
# Show tool names like: myproject:create_task

# 3. Update CHANGELOG.md
vim CHANGELOG.md
# Add entry for v1.8.0 adoption
```

### Step 8: Commit

```bash
git add -A
git commit -m "feat: Adopt Chora MCP Conventions v1.0 (chora-base v1.8.0)"
```

---

## Selective Upgrade Path

For **production MCP servers** with custom implementations.

### Strategy: Cherry-Pick Features

Instead of full replacement, selectively adopt v1.8.0 features:

#### Option A: Add Validation Only

Keep your existing server, add validation tooling:

```bash
# 1. Update template
copier update --vcs-ref=v1.8.0

# 2. When prompted, answer:
#    mcp_enable_namespacing: false  # Keep your current naming
#    mcp_validate_names: false      # Skip validation (for now)

# 3. Cherry-pick files you want:
git checkout origin/main -- docs/standards/CHORA_MCP_CONVENTIONS_v1.0.md
git checkout origin/main -- docs/reference/mcp-naming-best-practices.md
git checkout origin/main -- scripts/validate_mcp_names.py

# 4. Commit
git commit -m "docs: Add Chora MCP Conventions v1.0 reference"
```

#### Option B: Add Namespacing to Existing Server

Migrate existing server to use namespacing:

```bash
# 1. Backup current server
cp src/{package}/server.py src/{package}/server.py.backup

# 2. Update template with namespacing
copier update --vcs-ref=v1.8.0
# Answer: mcp_enable_namespacing=true

# 3. Review new files
ls src/{package}/mcp/

# 4. Import namespace utilities in your server
# Add to your existing server.py:
from {package}.mcp import make_tool_name, make_resource_uri, NAMESPACE

# 5. Update tool names (example):
# Old:
@mcp.tool()
async def create_task(...):
    # tool name: "create_task"

# New:
@mcp.tool()
async def create_task(...):
    tool_name = make_tool_name("create_task")
    # tool name: "myproject:create_task"

# 6. Run migration script
./scripts/migrate_namespace.sh "" "myproject"

# 7. Validate
python scripts/validate_mcp_names.py
```

#### Option C: Documentation Only

Just add documentation, no code changes:

```bash
copier update --vcs-ref=v1.8.0

# When prompted, answer:
#   mcp_enable_namespacing: false
#   mcp_validate_names: false

# Keep only docs:
git add docs/standards/
git add docs/reference/mcp-naming-best-practices.md

git commit -m "docs: Add MCP naming conventions reference"
```

---

## Troubleshooting

### Problem: Entry point not found after upgrade

**Symptom:**
```
Error: Could not find module 'myproject.server'
```

**Cause:** Entry point changed from `{package}.server:main` to `{package}.mcp.server:main`

**Solution:**
```bash
# Option 1: Update pyproject.toml manually
vim pyproject.toml
# Change:
#   [project.scripts]
#   myproject = "myproject.server:main"
# To:
#   myproject = "myproject.mcp.server:main"

# Option 2: Re-run copier (accept pyproject.toml changes)
copier update --vcs-ref=v1.8.0 --force

# Reinstall
pip install -e .
```

### Problem: Validation fails for existing tools

**Symptom:**
```
❌ InvalidToolName: create_task
  Must match pattern: myproject:tool_name
```

**Cause:** Existing tools not using namespaced names

**Solutions:**

1. **Add namespacing (recommended):**
   ```bash
   ./scripts/migrate_namespace.sh "" "myproject"
   ```

2. **Disable validation (temporary):**
   ```python
   # In src/{package}/mcp/__init__.py
   ENABLE_VALIDATION = False
   ```

3. **Skip validation (opt-out):**
   ```bash
   # Re-run copier
   copier update --vcs-ref=v1.8.0
   # Answer: mcp_validate_names=false
   ```

### Problem: Client configurations break

**Symptom:**
```
Claude Desktop: Tool 'create_task' not found
```

**Cause:** Tools now have namespace prefix

**Solution:**

Update Claude Desktop config (`~/Library/Application Support/Claude/claude_desktop_config.json`):

```json
{
  "mcpServers": {
    "myproject": {
      "command": "myproject",
      "args": []
    }
  }
}
```

Then update tool calls:
```
Old: create_task
New: myproject:create_task
```

**Or use standalone mode (no namespacing):**
```bash
copier update --vcs-ref=v1.8.0
# Answer: mcp_enable_namespacing=false
```

### Problem: Copier conflicts

**Symptom:**
```
Conflict when updating: src/{package}/server.py
```

**Cause:** Copier detected custom changes

**Solution:**

1. **Review conflict:**
   ```bash
   git diff src/{package}/server.py
   ```

2. **Choose strategy:**
   - Accept copier version (lose customizations)
   - Keep your version (miss new features)
   - Manually merge (best but requires effort)

3. **Manual merge example:**
   ```bash
   # Keep your version
   git checkout --ours src/{package}/server.py

   # Extract your tool implementations
   # Add them to new src/{package}/mcp/server.py
   vim src/{package}/mcp/server.py
   ```

---

## Rollback Procedure

If upgrade causes issues:

```bash
# 1. Check what version you came from
cat .copier-answers.yml | grep _commit

# 2. Rollback to previous version
copier update --vcs-ref=v1.7.0

# 3. Or revert git commits
git log --oneline  # Find commit before upgrade
git revert <commit-hash>

# 4. Reinstall dependencies
pip install -e ".[dev]"
```

---

## Post-Upgrade Tasks

### For MCP Servers with Namespacing

1. **Register Namespace in Ecosystem**
   - Submit PR to [chora-base](https://github.com/liminalcommons/chora-base)
   - Add entry to `docs/standards/CHORA_MCP_CONVENTIONS_v1.0.md § Ecosystem Registry`

2. **Update Client Configurations**
   - Claude Desktop: Update tool names to `namespace:tool`
   - mcp-n8n Gateway: Add backend config with namespace

3. **Document Breaking Changes**
   - Update CHANGELOG.md
   - Mark as breaking if changing from non-namespaced
   - Provide migration guide for users

4. **Version Bump (If Breaking)**
   ```bash
   # If you added namespacing to existing server
   ./scripts/bump-version.sh major  # e.g., 1.0.0 → 2.0.0
   ```

### For All Projects

1. **Update CONTRIBUTING.md**
   - Reference new MCP conventions
   - Link to NAMESPACES.md

2. **Run Full Test Suite**
   ```bash
   ./scripts/pre-merge.sh
   ```

3. **Update Documentation**
   - README.md: Show namespaced tool examples
   - AGENTS.md: Reference MCP conventions

---

## FAQ

### Do I have to use namespacing?

**No.** Namespacing is opt-in via `mcp_enable_namespacing` copier option.

**However**, it's strongly recommended if:
- Integrating with mcp-n8n gateway
- Multiple MCP servers in ecosystem
- Planning future multi-server support

### Can I change my namespace later?

**Yes, but it's a breaking change.** Use `./scripts/migrate_namespace.sh` and:
- Increment major version
- Update all client configurations
- Document in CHANGELOG

**Better:** Choose carefully upfront, treat as immutable.

### What if my project-slug is too long (>20 chars)?

Use abbreviated namespace:
```bash
# project-slug: my-very-long-awesome-project-name
# Abbreviated namespace: mvlapn (or mylongproject)

copier update --vcs-ref=v1.8.0
# When prompted for mcp_namespace: mylongproject
```

Document abbreviation in NAMESPACES.md.

### Does this work with existing mcp-n8n gateway?

**Yes!** v1.8.0 conventions are based on mcp-n8n's established patterns:
- Tool routing: `namespace:*` → backend
- Resource aggregation: `namespace://*`
- Gateway config: Add your namespace to backends

### Can I disable validation?

**Yes:**
```bash
copier update --vcs-ref=v1.8.0
# Answer: mcp_validate_names=false
```

Or toggle in code:
```python
# src/{package}/mcp/__init__.py
ENABLE_VALIDATION = False
```

---

## Support

- **Issues:** https://github.com/liminalcommons/chora-base/issues
- **Discussions:** https://github.com/liminalcommons/chora-base/discussions
- **Standards:** [Chora MCP Conventions v1.0](../standards/CHORA_MCP_CONVENTIONS_v1.0.md)
- **Best Practices:** [MCP Naming Best Practices](../reference/mcp-naming-best-practices.md)

---

## Example Upgrade Sessions

### Example 1: New MCP Server (Full Features)

```bash
# Project: task-master MCP server (new project, no custom code)

# 1. Update
copier update --vcs-ref=v1.8.0

# 2. Answer prompts
#    mcp_namespace: taskmaster  # project-slug without hyphen
#    mcp_enable_namespacing: true
#    mcp_resource_uri_scheme: true
#    mcp_validate_names: true

# 3. Review (all new, no conflicts)
git diff --stat
#  src/task_master/mcp/__init__.py           | 285 +++++++++++++++++++++++++++++
#  src/task_master/mcp/server.py              | 156 ++++++++++++++++
#  NAMESPACES.md                              | 243 ++++++++++++++++++++++++
#  scripts/validate_mcp_names.py              | 412 +++++++++++++++++++++++++++++++++++++++
#  scripts/migrate_namespace.sh               | 298 +++++++++++++++++++++++++++++
#  docs/standards/CHORA_MCP_CONVENTIONS_v1.0.md | 756 ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#  docs/reference/mcp-naming-best-practices.md | 523 ++++++++++++++++++++++++++++++++++++++++++++++
#  pyproject.toml                             |   2 +-
#  8 files changed, 2674 insertions(+), 1 deletion(-)

# 4. Validate
python scripts/validate_mcp_names.py
# ✅ All MCP names follow Chora MCP Conventions v1.0

# 5. Test
pytest
# ✅ 5 passed

# 6. Commit
git add -A
git commit -m "feat: Adopt Chora MCP Conventions v1.0"

# Done! Total time: ~5 minutes
```

### Example 2: Existing MCP Server (Selective Adoption)

```bash
# Project: my-mcp-server (production server, custom tools, non-namespaced)

# 1. Backup
git checkout -b upgrade-v1.8.0

# 2. Update (cautiously)
copier update --vcs-ref=v1.8.0

# 3. Answer conservatively
#    mcp_namespace: mymcpserver
#    mcp_enable_namespacing: false  # Keep current naming (for now)
#    mcp_resource_uri_scheme: false
#    mcp_validate_names: false

# 4. Review (minimal changes)
git diff --stat
#  docs/standards/CHORA_MCP_CONVENTIONS_v1.0.md | 756 +++++++++++++++++++++
#  docs/reference/mcp-naming-best-practices.md | 523 +++++++++++++++
#  2 files changed, 1279 insertions(+)

# 5. Keep documentation, plan migration for later
git add docs/
git commit -m "docs: Add Chora MCP Conventions v1.0 reference"

# 6. Plan Phase 2 (after docs review)
#    - Enable namespacing in next sprint
#    - Use migration script: ./scripts/migrate_namespace.sh "" "mymcpserver"
#    - Test thoroughly in staging
#    - Release as v2.0.0 (breaking change)

# Done! Total time: ~10 minutes (docs only)
```

---

**Last Updated:** 2025-10-21
**chora-base Version:** 1.8.0

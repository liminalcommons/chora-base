# Upgrade Guide: v1.8.1 → v1.8.2

**Upgrade Type:** Patch (backward compatible, bug fix)
**Upgrade Difficulty:** Easy
**Estimated Time:** 5-10 minutes

---

## What's New in v1.8.2

### MCP Server Version Drift Fix

v1.8.2 resolves a version synchronization issue where MCP servers generated from chora-base had hardcoded versions that would drift from `pyproject.toml`.

**Problem Fixed:**
- ❌ Before: `version="{{ project_version }}"` hardcoded at template generation
- ❌ Before: Required manual sync in two places when bumping version
- ❌ Before: MCP clients reported stale version (e.g., `0.1.0` when package was `1.5.0`)

**Solution:**
- ✅ After: Dynamic version resolution using `importlib.metadata`
- ✅ After: Single source of truth (`pyproject.toml`)
- ✅ After: Auto-syncs in dev and production environments

**Who Should Upgrade:**
- **MCP Server projects**: Recommended (eliminates manual version sync)
- **Other project types**: Not applicable (no changes for non-MCP projects)

---

## Before You Start

### Prerequisites

1. **Clean Git State**
   ```bash
   git status  # Should show "nothing to commit, working tree clean"
   ```

2. **Verify Project Type**
   ```bash
   # Check if you have an MCP server
   ls src/*/mcp/server.py 2>/dev/null
   ```

3. **Note Current Version**
   ```bash
   # Check your current package version
   grep '^version = ' pyproject.toml
   ```

### Decision Tree

**Question: Is your project an MCP server (`project_type: mcp_server`)?**
- **No** → No upgrade needed (this fix only affects MCP servers)
- **Yes** → Continue to [Upgrade Path](#upgrade-path)

---

## Upgrade Path

### Step 1: Update Template (Optional)

If you want to regenerate from the latest template:

```bash
# Update to v1.8.2
copier update --vcs-ref=v1.8.2

# Review changes (should only affect server.py template)
git diff
```

**Expected changes:**
- `template/src/{{package_name}}/mcp/server.py.jinja` - Dynamic version resolution

### Step 2: Manual Adoption (Recommended)

For existing projects, adopt the pattern manually:

#### 2.1 Update `src/{package_name}/mcp/server.py`

**Before:**
```python
from fastmcp import FastMCP

# === MCP Server Instance ===

mcp = FastMCP(
    name="my-project",
    version="0.1.0",  # ❌ Hardcoded - drifts from pyproject.toml
)
```

**After:**
```python
from importlib.metadata import PackageNotFoundError, version
from fastmcp import FastMCP

# === Version Resolution ===

def _get_version() -> str:
    """Get package version from installed metadata.

    Returns version from pyproject.toml (via package metadata) to ensure
    single source of truth. Falls back to development version if package
    is not installed (e.g., during development without editable install).

    Returns:
        Package version string (e.g., "1.5.0") or "0.0.0-dev" if not found.
    """
    try:
        return version("my_package_name")  # ✅ Replace with your package_name
    except PackageNotFoundError:
        # Development fallback when package not installed
        return "0.0.0-dev"

# === MCP Server Instance ===

mcp = FastMCP(
    name="my-project",
    version=_get_version(),  # ✅ Dynamic version from pyproject.toml
)
```

**Find your package name:**
```bash
# Your package_name is in pyproject.toml
grep '^name = ' pyproject.toml
# Example output: name = "my-project"
# Use: version("my-project")
```

#### 2.2 Update `get_capabilities()` Resource (If Exists)

If you have a capabilities resource that returns version:

**Before:**
```python
@mcp.resource(uri="...")
async def get_capabilities() -> dict[str, Any]:
    return {
        "name": "my-project",
        "version": "0.1.0",  # ❌ Hardcoded
        ...
    }
```

**After:**
```python
@mcp.resource(uri="...")
async def get_capabilities() -> dict[str, Any]:
    return {
        "name": "my-project",
        "version": _get_version(),  # ✅ Dynamic
        ...
    }
```

### Step 3: Test Version Resolution

#### 3.1 Verify in Development

```bash
# Ensure package is installed in editable mode
pip install -e .

# Test that version resolves correctly
python -c "from importlib.metadata import version; print(version('your-package-name'))"

# Start your MCP server and check logs
your-mcp-server
```

**Expected output:**
```
Starting my-project MCP server...
Version: 1.5.0  # ✅ Should match pyproject.toml
```

#### 3.2 Verify in Claude Desktop

If using Claude Desktop, check the MCP client logs:

```bash
# macOS
tail -f ~/Library/Logs/Claude/mcp*.log

# Look for serverInfo
# Expected: "serverInfo":{"name":"my-project","version":"1.5.0"}
```

#### 3.3 Test Version Bump

```bash
# 1. Update version in pyproject.toml
sed -i '' 's/version = "0.1.0"/version = "0.2.0"/' pyproject.toml

# 2. Reinstall package (to update metadata)
pip install -e .

# 3. Restart MCP server and verify new version
your-mcp-server

# Expected: Version: 0.2.0 ✅
```

### Step 4: Commit Changes

```bash
# Stage changes
git add src/*/mcp/server.py pyproject.toml

# Commit with template reference
git commit -m "fix(mcp): Implement dynamic version resolution

Adopt chora-base v1.8.2 pattern for version sync.

- Use importlib.metadata.version() for dynamic lookup
- Single source of truth: pyproject.toml
- Falls back to 0.0.0-dev in development

Fixes version drift issue where MCP clients reported stale version.

🤖 Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>"
```

---

## Verification Checklist

After upgrading, verify:

- [ ] `_get_version()` function exists in `server.py`
- [ ] `importlib.metadata` imported correctly
- [ ] `mcp = FastMCP(..., version=_get_version())`
- [ ] Any capabilities resources use `_get_version()`
- [ ] `pip install -e .` succeeds
- [ ] `python -c "from importlib.metadata import version; print(version('pkg'))"` returns correct version
- [ ] MCP server starts without errors
- [ ] Server logs show correct version
- [ ] Version bump in `pyproject.toml` propagates automatically

---

## Troubleshooting

### Issue: `PackageNotFoundError` When Starting Server

**Symptom:**
```
Starting my-project MCP server...
Version: 0.0.0-dev
```

**Cause:** Package not installed or not installed in editable mode.

**Solution:**
```bash
# Install in editable mode
pip install -e .

# Verify installation
pip list | grep your-package-name
```

### Issue: Version Still Shows Old Value

**Symptom:** After bumping version in `pyproject.toml`, server still reports old version.

**Cause:** Package metadata not updated.

**Solution:**
```bash
# Reinstall to update metadata
pip install -e . --force-reinstall

# Or just reinstall normally (faster)
pip uninstall your-package-name
pip install -e .
```

### Issue: Import Error for `importlib.metadata`

**Symptom:**
```
ModuleNotFoundError: No module named 'importlib.metadata'
```

**Cause:** Python version too old (need Python 3.8+).

**Solution:**
```bash
# Check Python version
python --version

# chora-base requires Python 3.11+
# Upgrade Python or use importlib_metadata backport
pip install importlib-metadata

# Then update import:
# from importlib_metadata import version  # For Python < 3.8
```

### Issue: Type Checker Complains About `version()`

**Symptom:**
```
mypy: error: Cannot find implementation or library stub for module named 'importlib.metadata'
```

**Solution:**
Add type stub or ignore:
```python
# Option 1: Update mypy config (pyproject.toml)
[[tool.mypy.overrides]]
module = ["importlib.metadata"]
ignore_missing_imports = true

# Option 2: Inline ignore
from importlib.metadata import version  # type: ignore
```

---

## Benefits After Upgrade

✅ **Single Source of Truth**: Version only defined in `pyproject.toml`
✅ **Auto-Sync**: No manual sync needed when bumping versions
✅ **Debug Clarity**: MCP clients always show correct version in logs
✅ **Best Practices**: Aligns with Python packaging ecosystem standards
✅ **Dev-Friendly**: Falls back gracefully in dev environments

---

## Rollback Procedure

If you need to revert:

```bash
# 1. Restore previous server.py
git checkout HEAD~1 src/*/mcp/server.py

# 2. Commit rollback
git commit -m "revert: Rollback to hardcoded version (temporary)"

# 3. Restart server
your-mcp-server
```

**Note:** Hardcoded version will work, but you'll need to manually sync `pyproject.toml` and `server.py` when bumping versions.

---

## Additional Notes

### Why `importlib.metadata`?

- **Standard Library**: Available in Python 3.8+ (chora-base requires 3.11+)
- **Build-System Agnostic**: Works with hatchling, setuptools, poetry, flit
- **Production Pattern**: Used by major Python libraries (requests, FastAPI, etc.)
- **No Extra Dependencies**: No need for `uv-dynamic-versioning` or similar

### Alternative: Git-Based Versioning

If you want Git tags as source of truth (like FastMCP upstream):

```bash
# Install uv-dynamic-versioning
pip install hatch-vcs

# Update pyproject.toml
[build-system]
requires = ["hatchling", "hatch-vcs"]

[tool.hatch.version]
source = "vcs"

# Tag your releases
git tag v1.0.0
git push --tags
```

**Note:** This is more complex and changes your build system. Only use if you need Git-tag-based versioning.

---

## References

- [Chora MCP Conventions v1.0](../standards/CHORA_MCP_CONVENTIONS_v1.0.md) - MCP naming standards
- [Python Packaging Documentation](https://packaging.python.org/en/latest/guides/single-sourcing-package-version/) - Version management best practices
- [importlib.metadata Documentation](https://docs.python.org/3/library/importlib.metadata.html) - Standard library reference
- [chora-compose Issue Report](https://github.com/liminalcommons/chora-compose) - Original bug report

---

## Questions?

If you encounter issues not covered in this guide:

1. Check [TROUBLESHOOTING.md](../../template/TROUBLESHOOTING.md.jinja) in your project
2. Review [chora-compose migration](https://github.com/liminalcommons/chora-compose) for real-world example
3. Open an issue at [chora-base/issues](https://github.com/liminalcommons/chora-base/issues)

**Upgrade completed successfully?** 🎉

Next: Consider upgrading to v1.9.0 when available for additional MCP server enhancements.

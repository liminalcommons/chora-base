{# Compute SAP enablement inline - workaround for Copier limitation with derived variables #}
{% set sap_001 = sap_selection_mode != 'custom' or (include_sap_001 | default(false)) %}
{% set sap_015 = sap_selection_mode != 'custom' or (include_sap_015 | default(false)) %}
{% set sap_053 = sap_selection_mode in ['standard', 'comprehensive'] or (sap_selection_mode == 'custom' and (include_sap_053 | default(false))) %}
{% set sap_010 = sap_selection_mode in ['standard', 'comprehensive'] or (sap_selection_mode == 'custom' and (include_sap_010 | default(false))) %}
{% set sap_051 = sap_selection_mode == 'comprehensive' or (sap_selection_mode == 'custom' and (include_sap_051 | default(false))) %}
{% set sap_052 = sap_selection_mode == 'comprehensive' or (sap_selection_mode == 'custom' and (include_sap_052 | default(false))) %}
{% set sap_056 = sap_selection_mode == 'comprehensive' or (sap_selection_mode == 'custom' and (include_sap_056 | default(false))) %}
{% set sap_008 = sap_selection_mode == 'comprehensive' or (sap_selection_mode == 'custom' and (include_sap_008 | default(false))) %}
{% set sap_total = [sap_001, sap_015, sap_053, sap_010, sap_051, sap_052, sap_056, sap_008] | select | list | length %}
{% if ((sap_selection_mode == 'comprehensive') or (sap_selection_mode == 'custom' and (include_sap_052 | default(false)))) %}#!/usr/bin/env {{ 'python' if use_poetry else 'python' + python_version }}
"""
SAP-052 Code Ownership Coverage Script

Check which files are covered by CODEOWNERS and report coverage percentage.

Usage:
    {{ 'poetry run python' if use_poetry else 'python' + python_version }} scripts/ownership-coverage.py
    {{ 'poetry run python' if use_poetry else 'python' + python_version }} scripts/ownership-coverage.py --quiet  # Exit code only
"""

import argparse
import re
import sys
from pathlib import Path
from typing import Dict, List, Set, Tuple


def find_repo_root() -> Path:
    """Find git repository root."""
    current = Path.cwd()
    while current != current.parent:
        if (current / '.git').exists():
            return current
        current = current.parent
    return Path.cwd()


def parse_codeowners(repo_root: Path) -> Dict[str, List[str]]:
    """Parse CODEOWNERS file and return pattern -> owners mapping."""
    codeowners_file = repo_root / 'CODEOWNERS'
    if not codeowners_file.exists():
        return {}

    patterns = {}
    with open(codeowners_file, 'r') as f:
        for line in f:
            line = line.strip()
            # Skip comments and empty lines
            if not line or line.startswith('#'):
                continue

            # Parse pattern and owners
            parts = line.split()
            if len(parts) >= 2:
                pattern = parts[0]
                owners = parts[1:]
                patterns[pattern] = owners

    return patterns


def get_tracked_files(repo_root: Path) -> Set[Path]:
    """Get all git-tracked files in the repository."""
    import subprocess

    try:
        result = subprocess.run(
            ['git', 'ls-files'],
            cwd=repo_root,
            capture_output=True,
            text=True,
            check=True
        )

        files = set()
        for line in result.stdout.strip().split('\n'):
            if line:
                files.add(repo_root / line)

        return files
    except subprocess.CalledProcessError:
        return set()


def matches_pattern(file_path: Path, pattern: str, repo_root: Path) -> bool:
    """Check if file matches CODEOWNERS pattern."""
    relative_path = file_path.relative_to(repo_root)
    path_str = str(relative_path)

    # Exact match
    if pattern == path_str or pattern == f"/{path_str}":
        return True

    # Directory match
    if pattern.endswith('/'):
        return path_str.startswith(pattern.rstrip('/') + '/')

    # Wildcard match
    if '*' in pattern:
        pattern_re = pattern.replace('*', '.*').replace('/', '\\/')
        if re.match(f"^{pattern_re}$", path_str):
            return True

    return False


def calculate_coverage(repo_root: Path, patterns: Dict[str, List[str]]) -> Tuple[int, int, List[Path]]:
    """Calculate ownership coverage."""
    tracked_files = get_tracked_files(repo_root)
    covered_files = set()

    for file_path in tracked_files:
        for pattern in patterns.keys():
            if matches_pattern(file_path, pattern, repo_root):
                covered_files.add(file_path)
                break

    uncovered_files = tracked_files - covered_files

    return len(covered_files), len(tracked_files), sorted(uncovered_files)


def main():
    parser = argparse.ArgumentParser(description='SAP-052 Code ownership coverage')
    parser.add_argument('--quiet', action='store_true', help='Quiet mode (exit code only)')
    args = parser.parse_args()

    repo_root = find_repo_root()
    patterns = parse_codeowners(repo_root)

    if not patterns:
        if not args.quiet:
            print("⚠️  No CODEOWNERS file found")
        sys.exit(1)

    covered, total, uncovered = calculate_coverage(repo_root, patterns)
    coverage_pct = (covered / total * 100) if total > 0 else 0

    if args.quiet:
        # Exit code 0 if >80% coverage, 1 otherwise
        sys.exit(0 if coverage_pct >= 80 else 1)

    # Print report
    print("=" * 60)
    print("SAP-052 Code Ownership Coverage Report")
    print("=" * 60)
    print(f"Covered files: {covered}/{total} ({coverage_pct:.1f}%)")
    print("")

    if coverage_pct >= 80:
        print("✅ Coverage meets threshold (80%)")
    else:
        print(f"⚠️  Coverage below threshold (80%): {coverage_pct:.1f}%")
        print("")
        print(f"Uncovered files ({len(uncovered)}):")
        for file_path in uncovered[:10]:  # Show first 10
            print(f"  - {file_path.relative_to(repo_root)}")

        if len(uncovered) > 10:
            print(f"  ... and {len(uncovered) - 10} more")

    print("=" * 60)
    sys.exit(0 if coverage_pct >= 80 else 1)


if __name__ == '__main__':
    main()
{% else %}#!/usr/bin/env python3
# SAP-052 (Code Ownership) not enabled for this project
print("SAP-052 not enabled")
{% endif %}

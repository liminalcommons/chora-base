#!/usr/bin/env bash
# Git hook: commit-msg
# Validates commit messages against Conventional Commits v1.0.0 spec
# Exit 0 = valid commit, Exit 1 = invalid commit (aborts)

set -e

COMMIT_MSG_FILE="$1"
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Configuration (can be overridden via git config)
ENABLED=$(git config --get hooks.commit-msg-enabled || echo "true")
if [ "$ENABLED" != "true" ]; then
    exit 0  # Hook disabled
fi

# Get allowed commit types from git config or use defaults
TYPES=$(git config --get conventional-commits.types || echo "feat,fix,docs,style,refactor,test,chore,perf,ci,build,revert")
MAX_SUBJECT_LENGTH=$(git config --get conventional-commits.max-subject-length || echo "72")
STRICT=$(git config --get conventional-commits.strict || echo "false")

# Convert comma-separated types to regex alternation
TYPES_REGEX=$(echo "$TYPES" | sed 's/,/|/g')

# Skip validation for merge commits (auto-generated by git)
if echo "$COMMIT_MSG" | head -1 | grep -qE "^Merge (branch|remote-tracking branch|pull request)"; then
    exit 0
fi

# Skip validation for revert commits (auto-generated)
if echo "$COMMIT_MSG" | head -1 | grep -qE "^Revert \""; then
    exit 0
fi

# Extract first line (subject)
SUBJECT=$(echo "$COMMIT_MSG" | head -1)

# Conventional Commits regex: <type>[optional scope]: <description>
# Pattern: type(scope): subject
# - type: one of allowed types
# - scope: optional, alphanumeric with hyphens/underscores
# - subject: required, starts with lowercase
PATTERN="^($TYPES_REGEX)(\(.+\))?!?: .+"

if ! echo "$SUBJECT" | grep -qE "$PATTERN"; then
    echo -e "${RED}❌ Commit message doesn't follow Conventional Commits format${NC}"
    echo ""
    echo "Expected: <type>(<scope>): <description>"
    echo ""
    echo "Valid types: $TYPES"
    echo ""
    echo "Examples:"
    echo "  feat(sap-051): add git workflow patterns"
    echo "  fix(git-hooks): correct validation regex"
    echo "  docs(readme): update installation instructions"
    echo "  chore: update dependencies"
    echo ""
    echo "Your commit message:"
    echo "  $SUBJECT"
    echo ""
    echo "Commit aborted."
    exit 1
fi

# Extract type and description for additional validation
TYPE=$(echo "$SUBJECT" | grep -oE "^($TYPES_REGEX)" || echo "")
DESCRIPTION=$(echo "$SUBJECT" | sed -E "s/^($TYPES_REGEX)(\(.+\))?!?: //" || echo "")

# Validate description starts with lowercase (unless it's an acronym or proper noun)
if echo "$DESCRIPTION" | grep -qE "^[A-Z][a-z]"; then
    if [ "$STRICT" == "true" ]; then
        echo -e "${RED}❌ Description should start with lowercase${NC}"
        echo "  Current: $DESCRIPTION"
        echo "  Fix: $(echo "$DESCRIPTION" | awk '{print tolower(substr($0,1,1)) substr($0,2)}')"
        echo ""
        echo "Commit aborted (strict mode enabled)."
        exit 1
    else
        echo -e "${YELLOW}⚠ Warning: Description should start with lowercase${NC}"
        echo "  Current: $DESCRIPTION"
    fi
fi

# Validate subject length
SUBJECT_LENGTH=${#SUBJECT}
if [ "$SUBJECT_LENGTH" -gt "$MAX_SUBJECT_LENGTH" ]; then
    if [ "$STRICT" == "true" ]; then
        echo -e "${RED}❌ Subject line too long: $SUBJECT_LENGTH characters (max: $MAX_SUBJECT_LENGTH)${NC}"
        echo "  $SUBJECT"
        echo ""
        echo "Commit aborted (strict mode enabled)."
        exit 1
    else
        echo -e "${YELLOW}⚠ Warning: Subject line is $SUBJECT_LENGTH characters (recommended max: $MAX_SUBJECT_LENGTH)${NC}"
    fi
fi

# Validate description doesn't end with period
if echo "$DESCRIPTION" | grep -qE "\.$"; then
    if [ "$STRICT" == "true" ]; then
        echo -e "${RED}❌ Description should not end with period${NC}"
        echo "  Current: $DESCRIPTION"
        echo ""
        echo "Commit aborted (strict mode enabled)."
        exit 1
    else
        echo -e "${YELLOW}⚠ Warning: Description should not end with period${NC}"
    fi
fi

# Debug output (if enabled)
if [ "${GIT_WORKFLOW_DEBUG:-false}" == "true" ]; then
    echo "Debug: commit-msg hook validated successfully"
    echo "  Type: $TYPE"
    echo "  Description: $DESCRIPTION"
    echo "  Subject length: $SUBJECT_LENGTH"
fi

# Success
echo -e "${GREEN}✓ commit-msg validation passed${NC}"
exit 0

#!/usr/bin/env python3
"""Pre-commit hook: Validate Windows compatibility

This hook validates that all Python files follow Windows compatibility best practices:
1. Scripts using emojis have UTF-8 console reconfiguration
2. File I/O operations include explicit encoding='utf-8'
3. No new bash scripts are added

Installation:
    # Option 1: Use git config (recommended)
    git config core.hooksPath .githooks

    # Option 2: Copy to .git/hooks/
    cp .githooks/pre-commit-windows-compat .git/hooks/pre-commit
    chmod +x .git/hooks/pre-commit

Usage:
    This hook runs automatically on git commit.
    To bypass (not recommended): git commit --no-verify
"""

import subprocess
import sys
from pathlib import Path

# Configure UTF-8 output for Windows console compatibility
if sys.platform == 'win32':
    sys.stdout.reconfigure(encoding='utf-8')
    sys.stderr.reconfigure(encoding='utf-8')


def get_staged_files():
    """Get list of staged Python files"""
    try:
        result = subprocess.run(
            ['git', 'diff', '--cached', '--name-only', '--diff-filter=ACM'],
            capture_output=True,
            text=True,
            check=True
        )
        files = result.stdout.strip().split('\n')
        return [f for f in files if f]
    except subprocess.CalledProcessError:
        return []


def check_new_bash_scripts(staged_files):
    """Check for new bash scripts"""
    bash_scripts = [f for f in staged_files if f.endswith('.sh') and f.startswith('scripts/')]

    if bash_scripts:
        print("‚ùå ERROR: New bash scripts detected!")
        print()
        print("Chora-base requires cross-platform compatibility (Windows, Mac, Linux).")
        print("Bash scripts are not supported on Windows without WSL/Git Bash.")
        print()
        print("Blocked files:")
        for script in bash_scripts:
            print(f"  - {script}")
        print()
        print("Required action:")
        print("  1. Rewrite as Python script (see scripts/fix-encoding-issues.py as example)")
        print("  2. Follow cross-platform patterns (see docs/skilled-awareness/cross-platform-fundamentals/)")
        print()
        print("Reference:")
        print("  - Bash to Python Migration: docs/user-docs/how-to/bash-to-python-migration.md")
        print("  - Cross-Platform Fundamentals: docs/skilled-awareness/cross-platform-fundamentals/")
        print()
        return False

    return True


def check_windows_compatibility(staged_files):
    """Run Windows compatibility validation on staged Python files"""
    python_files = [f for f in staged_files if f.endswith('.py')]

    if not python_files:
        return True

    # Create temporary file list
    temp_file = Path('.git/staged-files.txt')
    try:
        temp_file.write_text('\n'.join(python_files), encoding='utf-8')

        # Run validation script
        result = subprocess.run(
            ['python', 'scripts/validate-windows-compat.py', '--scripts-only'],
            capture_output=True,
            text=True
        )

        # Check for critical issues only
        if 'CRITICAL ISSUES' in result.stdout:
            print("‚ùå ERROR: Windows compatibility issues found in staged files!")
            print()
            print(result.stdout)
            print()
            print("Required action:")
            print("  1. Run: python scripts/fix-encoding-issues.py --apply")
            print("  2. Review changes and re-stage files")
            print("  3. Try commit again")
            print()
            print("To bypass this check (not recommended):")
            print("  git commit --no-verify")
            print()
            return False

    finally:
        if temp_file.exists():
            temp_file.unlink()

    return True


def main():
    """Main pre-commit hook logic"""
    print("üîç Running Windows compatibility checks...")

    staged_files = get_staged_files()

    if not staged_files:
        print("‚úÖ No files to check")
        return 0

    # Check 1: No new bash scripts
    if not check_new_bash_scripts(staged_files):
        return 1

    # Check 2: Windows compatibility for Python files
    if not check_windows_compatibility(staged_files):
        return 1

    print("‚úÖ All Windows compatibility checks passed")
    return 0


if __name__ == '__main__':
    sys.exit(main())

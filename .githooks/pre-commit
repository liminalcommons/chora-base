#!/usr/bin/env bash
# Git hook: pre-commit
# Optional hook for pre-commit checks (linting, formatting, etc.)
# Exit 0 = valid commit, Exit 1 = invalid commit (aborts)

set -e

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Configuration (disabled by default, enable via git config)
ENABLED=$(git config --get hooks.pre-commit-enabled || echo "false")
if [ "$ENABLED" != "true" ]; then
    # Hook disabled by default, exit silently
    exit 0
fi

echo "Running pre-commit checks..."

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# Check for trailing whitespace (basic check)
WHITESPACE_FILES=$(echo "$STAGED_FILES" | xargs grep -l "[[:space:]]$" 2>/dev/null || true)
if [ -n "$WHITESPACE_FILES" ]; then
    echo -e "${YELLOW}⚠ Warning: Files with trailing whitespace:${NC}"
    echo "$WHITESPACE_FILES" | sed 's/^/  /'
    echo ""
    echo "Fix with: sed -i 's/[[:space:]]*$//' <file>"
    echo ""
fi

# Check for large files (> 1MB, potential binary files)
LARGE_FILES=$(echo "$STAGED_FILES" | xargs ls -lh 2>/dev/null | awk '$5 ~ /M$/ {print $9}' || true)
if [ -n "$LARGE_FILES" ]; then
    echo -e "${YELLOW}⚠ Warning: Large files being committed:${NC}"
    echo "$LARGE_FILES" | sed 's/^/  /'
    echo ""
    echo "Consider using Git LFS for large binary files."
    echo ""
fi

# Check for potential secrets (basic pattern matching)
SECRET_PATTERNS="password=|api_key=|secret=|token=|AWS_SECRET|GITHUB_TOKEN"
SECRET_FILES=$(echo "$STAGED_FILES" | xargs grep -iE "$SECRET_PATTERNS" 2>/dev/null || true)
if [ -n "$SECRET_FILES" ]; then
    echo -e "${RED}❌ Potential secrets detected in staged files:${NC}"
    echo "$SECRET_FILES" | sed 's/^/  /'
    echo ""
    echo "Remove secrets before committing!"
    echo "Commit aborted."
    exit 1
fi

# Debug output (if enabled)
if [ "${GIT_WORKFLOW_DEBUG:-false}" == "true" ]; then
    echo "Debug: pre-commit hook validated successfully"
    echo "  Staged files: $(echo "$STAGED_FILES" | wc -l)"
fi

# Success
echo -e "${GREEN}✓ pre-commit checks passed${NC}"
exit 0

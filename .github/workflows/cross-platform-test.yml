name: Cross-Platform Compatibility

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:  # Allow manual trigger

jobs:
  test:
    name: Test on ${{ matrix.os }} - Python ${{ matrix.python-version }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false  # Continue testing other platforms if one fails
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ['3.8', '3.11']

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Display Python version and platform
        run: |
          python --version
          python -c "import sys; print(f'Platform: {sys.platform}')"
          python -c "import sys; print(f'Default encoding: {sys.getdefaultencoding()}')"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install jinja2 pyyaml

      - name: Validate Windows compatibility
        run: python scripts/validate-windows-compat.py --scripts-only

      - name: Test core scripts - Help output
        run: |
          python scripts/create-model-mcp-server.py --help
          python scripts/install-sap.py --help
          python scripts/validate-sap-infrastructure.py --help
          python scripts/generate-sap.py --help || true

      - name: Test core scripts - List operations
        run: |
          python scripts/install-sap.py --list || true

      - name: Test platform detection
        run: python scripts/platform-info.py

      - name: Test fast-setup dry-run (Unix/Mac)
        if: matrix.os != 'windows-latest'
        run: |
          python scripts/create-model-mcp-server.py \
            --name "CI Test MCP" \
            --namespace citest \
            --output ./test-output \
            --skip-validation \
            --skip-git

      - name: Test fast-setup dry-run (Windows)
        if: matrix.os == 'windows-latest'
        shell: bash  # Use Git Bash on Windows
        run: |
          python scripts/create-model-mcp-server.py \
            --name "CI Test MCP" \
            --namespace citest \
            --output ./test-output \
            --skip-validation \
            --skip-git

      - name: Verify generated files have UTF-8 encoding
        run: |
          python -c "
          from pathlib import Path
          import sys

          test_output = Path('test-output')
          if not test_output.exists():
              print('âŒ test-output directory not found')
              sys.exit(1)

          readme = test_output / 'README.md'
          if readme.exists():
              try:
                  content = readme.read_text(encoding='utf-8')
                  print(f'âœ… README.md has {len(content)} chars (UTF-8 encoded)')
              except UnicodeDecodeError:
                  print('âŒ README.md has encoding issues')
                  sys.exit(1)
          else:
              print('âŒ README.md not found')
              sys.exit(1)

          print('âœ… All encoding tests passed')
          "

      - name: Test emoji output (critical for Windows)
        run: |
          python -c "
          import sys

          # Configure UTF-8 for Windows
          if sys.platform == 'win32':
              sys.stdout.reconfigure(encoding='utf-8')

          # Test emoji output
          print('Testing emoji output: âœ… âŒ âš ï¸ ðŸš€')
          print(f'Platform: {sys.platform}')
          print('If you see emojis above (or ? boxes), the test passed!')
          "

      - name: Cleanup test output
        if: always()
        run: |
          python -c "
          from pathlib import Path
          import shutil

          test_output = Path('test-output')
          if test_output.exists():
              shutil.rmtree(test_output)
              print('âœ… Cleaned up test-output')
          "

  validation-report:
    name: Validation Report
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install jinja2 pyyaml

      - name: Generate full validation report
        run: |
          echo "# Cross-Platform Validation Report" > validation-report.md
          echo "" >> validation-report.md
          echo "**Date**: $(date -u +%Y-%m-%d)" >> validation-report.md
          echo "**Commit**: ${{ github.sha }}" >> validation-report.md
          echo "" >> validation-report.md
          echo "## Validation Results" >> validation-report.md
          echo "" >> validation-report.md
          echo "\`\`\`" >> validation-report.md
          python scripts/validate-windows-compat.py --scripts-only >> validation-report.md || true
          echo "\`\`\`" >> validation-report.md
          cat validation-report.md

      - name: Upload validation report
        uses: actions/upload-artifact@v3
        with:
          name: validation-report
          path: validation-report.md
          retention-days: 30

  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: test
    if: always()

    steps:
      - name: Check test results
        run: |
          echo "Cross-platform tests completed!"
          echo "Check individual job results for details."

"""Tests for {{ capability_name }} Service Registry (SAP-044)

Tests verify service registration, discovery, health monitoring, and
capability-based lookups.

Generated by: chora-base SAP-047 (Capability Server Template)
"""

import asyncio
from datetime import datetime, timedelta
from uuid import uuid4

import pytest

from {{ package_name }}.infrastructure.registry import (
    ServiceRegistry,
    ServiceRegistration,
    ServiceStatus,
)


# ============================================================================
# Fixtures
# ============================================================================


@pytest.fixture
def registry():
    """Create service registry instance."""
    return ServiceRegistry(heartbeat_timeout_seconds=5)


@pytest.fixture
def sample_service_data():
    """Sample service registration data."""
    return {
        "service_name": "test-service",
        "service_type": "{{ capability_name_lower }}",
        "version": "1.0.0",
        "capabilities": ["create", "read", "update", "delete"],
        "interfaces": ["REST", "MCP"],
        "endpoints": {
            "rest": "http://localhost:8000",
            "mcp": "mcp://localhost:8001"
        },
        "metadata": {"environment": "test"}
    }


# ============================================================================
# Test Service Registration
# ============================================================================


class TestServiceRegistration:
    """Test service registration functionality."""

    def test_register_service(self, registry, sample_service_data):
        """Test registering a service."""
        registration = registry.register(**sample_service_data)

        assert registration.service_name == sample_service_data["service_name"]
        assert registration.service_type == sample_service_data["service_type"]
        assert registration.version == sample_service_data["version"]
        assert registration.status == ServiceStatus.HEALTHY
        assert len(registration.service_id) > 0

    def test_register_duplicate_service_name(self, registry, sample_service_data):
        """Test registering services with same name (should create separate instances)."""
        reg1 = registry.register(**sample_service_data)
        reg2 = registry.register(**sample_service_data)

        # Different IDs
        assert reg1.service_id != reg2.service_id

        # Both registered
        services = registry.list_services()
        assert len(services) == 2

    def test_register_with_minimal_data(self, registry):
        """Test registering service with minimal required data."""
        registration = registry.register(
            service_name="minimal-service",
            service_type="{{ capability_name_lower }}",
            version="1.0.0",
            capabilities=[],
            interfaces=["CLI"],
            endpoints={}
        )

        assert registration.service_name == "minimal-service"
        assert registration.capabilities == []

    def test_register_updates_last_heartbeat(self, registry, sample_service_data):
        """Test registration sets last_heartbeat timestamp."""
        before = datetime.utcnow()
        registration = registry.register(**sample_service_data)
        after = datetime.utcnow()

        assert before <= registration.last_heartbeat <= after


# ============================================================================
# Test Service Deregistration
# ============================================================================


class TestServiceDeregistration:
    """Test service deregistration functionality."""

    def test_deregister_service(self, registry, sample_service_data):
        """Test deregistering a service."""
        registration = registry.register(**sample_service_data)
        service_id = registration.service_id

        success = registry.deregister(service_id)
        assert success is True

        # Service should be gone
        service = registry.get_service(service_id)
        assert service is None

    def test_deregister_nonexistent_service(self, registry):
        """Test deregistering non-existent service returns False."""
        fake_id = uuid4()
        success = registry.deregister(fake_id)
        assert success is False

    def test_deregister_removes_from_lists(self, registry, sample_service_data):
        """Test deregistered service doesn't appear in lists."""
        registration = registry.register(**sample_service_data)
        service_id = registration.service_id

        registry.deregister(service_id)

        # Should not appear in list
        services = registry.list_services()
        assert len(services) == 0


# ============================================================================
# Test Service Discovery
# ============================================================================


class TestServiceDiscovery:
    """Test service discovery and lookups."""

    def test_get_service(self, registry, sample_service_data):
        """Test getting service by ID."""
        registration = registry.register(**sample_service_data)
        service_id = registration.service_id

        service = registry.get_service(service_id)
        assert service is not None
        assert service.service_id == service_id

    def test_get_nonexistent_service(self, registry):
        """Test getting non-existent service returns None."""
        fake_id = uuid4()
        service = registry.get_service(fake_id)
        assert service is None

    def test_list_all_services(self, registry, sample_service_data):
        """Test listing all services."""
        # Register 3 services
        for i in range(3):
            data = sample_service_data.copy()
            data["service_name"] = f"service-{i}"
            registry.register(**data)

        services = registry.list_services()
        assert len(services) == 3

    def test_list_services_by_type(self, registry):
        """Test filtering services by type."""
        # Register services of different types
        registry.register(
            service_name="service-1",
            service_type="type-a",
            version="1.0.0",
            capabilities=[],
            interfaces=["CLI"],
            endpoints={}
        )
        registry.register(
            service_name="service-2",
            service_type="type-b",
            version="1.0.0",
            capabilities=[],
            interfaces=["CLI"],
            endpoints={}
        )
        registry.register(
            service_name="service-3",
            service_type="type-a",
            version="1.0.0",
            capabilities=[],
            interfaces=["CLI"],
            endpoints={}
        )

        # Filter by type-a
        services = registry.list_services(service_type="type-a")
        assert len(services) == 2
        assert all(s.service_type == "type-a" for s in services)

    def test_list_services_by_status(self, registry, sample_service_data):
        """Test filtering services by status."""
        # Register service
        registration = registry.register(**sample_service_data)

        # Mark as unhealthy
        registry.mark_unhealthy(registration.service_id, "Test error")

        # List healthy services (should be empty)
        healthy = registry.list_services(status=ServiceStatus.HEALTHY)
        assert len(healthy) == 0

        # List unhealthy services
        unhealthy = registry.list_services(status=ServiceStatus.UNHEALTHY)
        assert len(unhealthy) == 1

    def test_list_services_by_interface(self, registry):
        """Test filtering services by interface."""
        # REST service
        registry.register(
            service_name="rest-service",
            service_type="{{ capability_name_lower }}",
            version="1.0.0",
            capabilities=[],
            interfaces=["REST"],
            endpoints={"rest": "http://localhost:8000"}
        )

        # MCP service
        registry.register(
            service_name="mcp-service",
            service_type="{{ capability_name_lower }}",
            version="1.0.0",
            capabilities=[],
            interfaces=["MCP"],
            endpoints={"mcp": "mcp://localhost:8001"}
        )

        # Multi-interface service
        registry.register(
            service_name="multi-service",
            service_type="{{ capability_name_lower }}",
            version="1.0.0",
            capabilities=[],
            interfaces=["REST", "MCP"],
            endpoints={
                "rest": "http://localhost:8000",
                "mcp": "mcp://localhost:8001"
            }
        )

        # Filter by REST
        rest_services = registry.list_services(interface="REST")
        assert len(rest_services) == 2  # rest-service and multi-service

        # Filter by MCP
        mcp_services = registry.list_services(interface="MCP")
        assert len(mcp_services) == 2  # mcp-service and multi-service


# ============================================================================
# Test Capability Discovery
# ============================================================================


class TestCapabilityDiscovery:
    """Test capability-based service discovery."""

    def test_discover_capability(self, registry):
        """Test finding services by capability."""
        # Service with "read" capability
        registry.register(
            service_name="reader",
            service_type="{{ capability_name_lower }}",
            version="1.0.0",
            capabilities=["read"],
            interfaces=["CLI"],
            endpoints={}
        )

        # Service with "write" capability
        registry.register(
            service_name="writer",
            service_type="{{ capability_name_lower }}",
            version="1.0.0",
            capabilities=["write"],
            interfaces=["CLI"],
            endpoints={}
        )

        # Service with both
        registry.register(
            service_name="full-service",
            service_type="{{ capability_name_lower }}",
            version="1.0.0",
            capabilities=["read", "write"],
            interfaces=["CLI"],
            endpoints={}
        )

        # Discover "read" capability
        readers = registry.discover_capability("read")
        assert len(readers) == 2  # reader and full-service

        # Discover "write" capability
        writers = registry.discover_capability("write")
        assert len(writers) == 2  # writer and full-service

    def test_discover_nonexistent_capability(self, registry, sample_service_data):
        """Test discovering capability with no providers."""
        registry.register(**sample_service_data)

        services = registry.discover_capability("nonexistent")
        assert len(services) == 0

    def test_discover_capability_filters_unhealthy(self, registry):
        """Test capability discovery only returns healthy services."""
        # Healthy service with capability
        reg1 = registry.register(
            service_name="healthy-service",
            service_type="{{ capability_name_lower }}",
            version="1.0.0",
            capabilities=["test"],
            interfaces=["CLI"],
            endpoints={}
        )

        # Unhealthy service with same capability
        reg2 = registry.register(
            service_name="unhealthy-service",
            service_type="{{ capability_name_lower }}",
            version="1.0.0",
            capabilities=["test"],
            interfaces=["CLI"],
            endpoints={}
        )
        registry.mark_unhealthy(reg2.service_id, "Test failure")

        # Should only return healthy service
        services = registry.discover_capability("test")
        assert len(services) == 1
        assert services[0].service_name == "healthy-service"


# ============================================================================
# Test Health Monitoring
# ============================================================================


class TestHealthMonitoring:
    """Test health monitoring and heartbeat functionality."""

    def test_heartbeat(self, registry, sample_service_data):
        """Test updating service heartbeat."""
        registration = registry.register(**sample_service_data)
        service_id = registration.service_id

        # Wait a bit
        asyncio.run(asyncio.sleep(0.1))

        # Update heartbeat
        original_heartbeat = registration.last_heartbeat
        success = registry.heartbeat(service_id)
        assert success is True

        # Heartbeat should be updated
        service = registry.get_service(service_id)
        assert service.last_heartbeat > original_heartbeat

    def test_heartbeat_nonexistent_service(self, registry):
        """Test heartbeat for non-existent service."""
        fake_id = uuid4()
        success = registry.heartbeat(fake_id)
        assert success is False

    def test_mark_unhealthy(self, registry, sample_service_data):
        """Test marking service as unhealthy."""
        registration = registry.register(**sample_service_data)
        service_id = registration.service_id

        registry.mark_unhealthy(service_id, "Test error")

        service = registry.get_service(service_id)
        assert service.status == ServiceStatus.UNHEALTHY
        assert service.metadata["error"] == "Test error"

    def test_mark_unhealthy_nonexistent_service(self, registry):
        """Test marking non-existent service as unhealthy (should not error)."""
        fake_id = uuid4()
        # Should not raise exception
        registry.mark_unhealthy(fake_id, "Test error")

    def test_check_timeouts(self, registry):
        """Test timeout detection for stale heartbeats."""
        # Register service
        registration = registry.register(
            service_name="test-service",
            service_type="{{ capability_name_lower }}",
            version="1.0.0",
            capabilities=[],
            interfaces=["CLI"],
            endpoints={}
        )

        # Manually set last_heartbeat to old timestamp
        service = registry.get_service(registration.service_id)
        service.last_heartbeat = datetime.utcnow() - timedelta(seconds=10)

        # Check timeouts
        timed_out = registry.check_timeouts()
        assert len(timed_out) == 1
        assert timed_out[0] == registration.service_id

        # Service should be marked unhealthy
        service = registry.get_service(registration.service_id)
        assert service.status == ServiceStatus.UNHEALTHY
        assert "timeout" in service.metadata.get("error", "").lower()

    def test_check_timeouts_healthy_services(self, registry, sample_service_data):
        """Test timeout check doesn't affect healthy services."""
        registration = registry.register(**sample_service_data)

        # Check timeouts (service was just registered)
        timed_out = registry.check_timeouts()
        assert len(timed_out) == 0

        # Service should still be healthy
        service = registry.get_service(registration.service_id)
        assert service.status == ServiceStatus.HEALTHY


# ============================================================================
# Test Statistics
# ============================================================================


class TestStatistics:
    """Test registry statistics."""

    def test_get_stats_empty(self, registry):
        """Test statistics for empty registry."""
        stats = registry.get_stats()

        assert stats["total_services"] == 0
        assert stats["healthy_services"] == 0
        assert stats["unhealthy_services"] == 0
        assert stats["services_by_type"] == {}
        assert stats["services_by_interface"] == {}

    def test_get_stats_with_services(self, registry):
        """Test statistics with registered services."""
        # Register 2 healthy services
        registry.register(
            service_name="service-1",
            service_type="type-a",
            version="1.0.0",
            capabilities=[],
            interfaces=["REST"],
            endpoints={}
        )
        registry.register(
            service_name="service-2",
            service_type="type-a",
            version="1.0.0",
            capabilities=[],
            interfaces=["MCP"],
            endpoints={}
        )

        # Register 1 unhealthy service
        reg3 = registry.register(
            service_name="service-3",
            service_type="type-b",
            version="1.0.0",
            capabilities=[],
            interfaces=["CLI"],
            endpoints={}
        )
        registry.mark_unhealthy(reg3.service_id, "Test error")

        stats = registry.get_stats()

        assert stats["total_services"] == 3
        assert stats["healthy_services"] == 2
        assert stats["unhealthy_services"] == 1
        assert stats["services_by_type"]["type-a"] == 2
        assert stats["services_by_type"]["type-b"] == 1
        assert stats["services_by_interface"]["REST"] == 1
        assert stats["services_by_interface"]["MCP"] == 1
        assert stats["services_by_interface"]["CLI"] == 1


# ============================================================================
# Test Service Registration Model
# ============================================================================


class TestServiceRegistrationModel:
    """Test ServiceRegistration model."""

    def test_registration_to_dict(self, sample_service_data):
        """Test converting registration to dictionary."""
        registration = ServiceRegistration(**sample_service_data)

        data = registration.to_dict()

        assert data["service_name"] == sample_service_data["service_name"]
        assert data["service_type"] == sample_service_data["service_type"]
        assert data["version"] == sample_service_data["version"]
        assert "service_id" in data
        assert "registered_at" in data
        assert "last_heartbeat" in data

    def test_registration_defaults(self):
        """Test default values in ServiceRegistration."""
        registration = ServiceRegistration(
            service_name="test",
            service_type="test",
            version="1.0.0",
            capabilities=[],
            interfaces=[],
            endpoints={}
        )

        assert registration.status == ServiceStatus.HEALTHY
        assert registration.metadata == {}
        assert len(str(registration.service_id)) > 0

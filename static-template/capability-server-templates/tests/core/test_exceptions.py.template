"""Tests for {{ capability_name }} Core Exceptions (SAP-042)

Tests verify exception hierarchy, error messages, and serialization
for domain exceptions.

Generated by: chora-base SAP-047 (Capability Server Template)
"""

import pytest

from {{ package_name }}.core.exceptions import (
    {{ capability_name_pascal }}ConfigError,
    {{ capability_name_pascal }}ConflictError,
    {{ capability_name_pascal }}Error,
    {{ capability_name_pascal }}NotFoundError,
    {{ capability_name_pascal }}PermissionError,
    {{ capability_name_pascal }}RateLimitError,
    {{ capability_name_pascal }}ServiceError,
    {{ capability_name_pascal }}TimeoutError,
    {{ capability_name_pascal }}ValidationError,
    get_error_code,
    get_error_details,
    is_{{ capability_name_snake }}_error,
)


# ============================================================================
# Test Base Exception
# ============================================================================


class Test{{ capability_name_pascal }}Error:
    """Test base exception class."""

    def test_create_base_error(self):
        """Test creating base error with message."""
        error = {{ capability_name_pascal }}Error("Test error")

        assert str(error) == "Test error"
        assert error.message == "Test error"
        assert error.code == "{{ capability_name_pascal }}Error"
        assert error.details == {}

    def test_error_with_code(self):
        """Test error with custom code."""
        error = {{ capability_name_pascal }}Error(
            "Test error",
            code="CUSTOM_CODE"
        )

        assert error.code == "CUSTOM_CODE"

    def test_error_with_details(self):
        """Test error with additional details."""
        error = {{ capability_name_pascal }}Error(
            "Test error",
            details={"key": "value", "count": 42}
        )

        assert error.details == {"key": "value", "count": 42}

    def test_error_to_dict(self):
        """Test error serialization to dictionary."""
        error = {{ capability_name_pascal }}Error(
            "Test error",
            code="TEST_ERROR",
            details={"field": "name"}
        )

        data = error.to_dict()

        assert data["error"] == "TEST_ERROR"
        assert data["message"] == "Test error"
        assert data["details"] == {"field": "name"}

    def test_error_str_with_details(self):
        """Test string representation includes details."""
        error = {{ capability_name_pascal }}Error(
            "Test error",
            details={"key": "value"}
        )

        error_str = str(error)
        assert "Test error" in error_str
        assert "details" in error_str


# ============================================================================
# Test Validation Error
# ============================================================================


class Test{{ capability_name_pascal }}ValidationError:
    """Test validation error class."""

    def test_create_validation_error(self):
        """Test creating validation error."""
        error = {{ capability_name_pascal }}ValidationError("Invalid input")

        assert isinstance(error, {{ capability_name_pascal }}Error)
        assert error.message == "Invalid input"
        assert error.code == "VALIDATION_ERROR"

    def test_validation_error_with_field(self):
        """Test validation error with field name."""
        error = {{ capability_name_pascal }}ValidationError(
            "Invalid value",
            field="email"
        )

        assert error.details["field"] == "email"

    def test_validation_error_with_value(self):
        """Test validation error with invalid value."""
        error = {{ capability_name_pascal }}ValidationError(
            "Invalid value",
            field="age",
            value=-1
        )

        assert error.details["field"] == "age"
        assert error.details["value"] == -1

    def test_validation_error_with_all_params(self):
        """Test validation error with all parameters."""
        error = {{ capability_name_pascal }}ValidationError(
            "Invalid email format",
            field="email",
            value="not-an-email",
            details={"expected_format": "user@domain.com"}
        )

        assert error.details["field"] == "email"
        assert error.details["value"] == "not-an-email"
        assert error.details["expected_format"] == "user@domain.com"


# ============================================================================
# Test Not Found Error
# ============================================================================


class Test{{ capability_name_pascal }}NotFoundError:
    """Test not found error class."""

    def test_create_not_found_error(self):
        """Test creating not found error."""
        error = {{ capability_name_pascal }}NotFoundError("Entity not found")

        assert isinstance(error, {{ capability_name_pascal }}Error)
        assert error.code == "NOT_FOUND"

    def test_not_found_with_entity_id(self):
        """Test not found error with entity ID."""
        error = {{ capability_name_pascal }}NotFoundError(
            "Entity not found",
            entity_id="123e4567-e89b-12d3-a456-426614174000"
        )

        assert "123e4567-e89b-12d3-a456-426614174000" in error.details["entity_id"]

    def test_not_found_with_entity_type(self):
        """Test not found error with entity type."""
        error = {{ capability_name_pascal }}NotFoundError(
            "Entity not found",
            entity_type="User"
        )

        assert error.details["entity_type"] == "User"


# ============================================================================
# Test Conflict Error
# ============================================================================


class Test{{ capability_name_pascal }}ConflictError:
    """Test conflict error class."""

    def test_create_conflict_error(self):
        """Test creating conflict error."""
        error = {{ capability_name_pascal }}ConflictError("Duplicate entry")

        assert isinstance(error, {{ capability_name_pascal }}Error)
        assert error.code == "CONFLICT"

    def test_conflict_with_conflicting_id(self):
        """Test conflict error with conflicting entity ID."""
        error = {{ capability_name_pascal }}ConflictError(
            "Duplicate entry",
            conflicting_id="existing-123"
        )

        assert error.details["conflicting_id"] == "existing-123"


# ============================================================================
# Test Permission Error
# ============================================================================


class Test{{ capability_name_pascal }}PermissionError:
    """Test permission error class."""

    def test_create_permission_error(self):
        """Test creating permission error."""
        error = {{ capability_name_pascal }}PermissionError("Access denied")

        assert isinstance(error, {{ capability_name_pascal }}Error)
        assert error.code == "PERMISSION_DENIED"

    def test_permission_with_required_permission(self):
        """Test permission error with required permission."""
        error = {{ capability_name_pascal }}PermissionError(
            "Access denied",
            required_permission="admin"
        )

        assert error.details["required_permission"] == "admin"


# ============================================================================
# Test Service Error
# ============================================================================


class Test{{ capability_name_pascal }}ServiceError:
    """Test service error class."""

    def test_create_service_error(self):
        """Test creating service error."""
        error = {{ capability_name_pascal }}ServiceError("Service unavailable")

        assert isinstance(error, {{ capability_name_pascal }}Error)
        assert error.code == "SERVICE_ERROR"

    def test_service_error_with_operation(self):
        """Test service error with operation name."""
        error = {{ capability_name_pascal }}ServiceError(
            "Operation failed",
            operation="database_query"
        )

        assert error.details["operation"] == "database_query"

    def test_service_error_with_cause(self):
        """Test service error with underlying cause."""
        cause = ValueError("Invalid connection string")
        error = {{ capability_name_pascal }}ServiceError(
            "Database connection failed",
            cause=cause
        )

        assert "Invalid connection string" in error.details["cause"]
        assert error.details["cause_type"] == "ValueError"


# ============================================================================
# Test Rate Limit Error
# ============================================================================


class Test{{ capability_name_pascal }}RateLimitError:
    """Test rate limit error class."""

    def test_create_rate_limit_error(self):
        """Test creating rate limit error."""
        error = {{ capability_name_pascal }}RateLimitError("Rate limit exceeded")

        assert isinstance(error, {{ capability_name_pascal }}Error)
        assert error.code == "RATE_LIMIT_EXCEEDED"

    def test_rate_limit_with_all_params(self):
        """Test rate limit error with all parameters."""
        error = {{ capability_name_pascal }}RateLimitError(
            "Rate limit exceeded",
            limit=100,
            window_seconds=60,
            retry_after_seconds=30
        )

        assert error.details["limit"] == 100
        assert error.details["window_seconds"] == 60
        assert error.details["retry_after_seconds"] == 30


# ============================================================================
# Test Timeout Error
# ============================================================================


class Test{{ capability_name_pascal }}TimeoutError:
    """Test timeout error class."""

    def test_create_timeout_error(self):
        """Test creating timeout error."""
        error = {{ capability_name_pascal }}TimeoutError("Operation timed out")

        assert isinstance(error, {{ capability_name_pascal }}Error)
        assert error.code == "TIMEOUT"

    def test_timeout_with_duration(self):
        """Test timeout error with duration."""
        error = {{ capability_name_pascal }}TimeoutError(
            "Query timed out",
            timeout_seconds=30.0,
            operation="database_query"
        )

        assert error.details["timeout_seconds"] == 30.0
        assert error.details["operation"] == "database_query"


# ============================================================================
# Test Config Error
# ============================================================================


class Test{{ capability_name_pascal }}ConfigError:
    """Test configuration error class."""

    def test_create_config_error(self):
        """Test creating config error."""
        error = {{ capability_name_pascal }}ConfigError("Missing configuration")

        assert isinstance(error, {{ capability_name_pascal }}Error)
        assert error.code == "CONFIG_ERROR"

    def test_config_error_with_key(self):
        """Test config error with config key."""
        error = {{ capability_name_pascal }}ConfigError(
            "Missing required config",
            config_key="DATABASE_URL"
        )

        assert error.details["config_key"] == "DATABASE_URL"


# ============================================================================
# Test Helper Functions
# ============================================================================


class TestHelperFunctions:
    """Test helper utility functions."""

    def test_is_{{ capability_name_snake }}_error_true(self):
        """Test is_error returns True for domain errors."""
        error = {{ capability_name_pascal }}ValidationError("Test")
        assert is_{{ capability_name_snake }}_error(error) is True

    def test_is_{{ capability_name_snake }}_error_false(self):
        """Test is_error returns False for non-domain errors."""
        error = ValueError("Test")
        assert is_{{ capability_name_snake }}_error(error) is False

    def test_get_error_code_for_domain_error(self):
        """Test get_error_code for domain error."""
        error = {{ capability_name_pascal }}NotFoundError("Not found")
        code = get_error_code(error)

        assert code == "NOT_FOUND"

    def test_get_error_code_for_generic_error(self):
        """Test get_error_code for generic error."""
        error = RuntimeError("Test")
        code = get_error_code(error)

        assert code == "UNKNOWN_ERROR"

    def test_get_error_details_for_domain_error(self):
        """Test get_error_details for domain error."""
        error = {{ capability_name_pascal }}ValidationError(
            "Invalid",
            field="name",
            value="x"
        )
        details = get_error_details(error)

        assert details["error"] == "VALIDATION_ERROR"
        assert details["message"] == "Invalid"
        assert details["details"]["field"] == "name"

    def test_get_error_details_for_generic_error(self):
        """Test get_error_details for generic error."""
        error = ValueError("Test error")
        details = get_error_details(error)

        assert details["error"] == "ValueError"
        assert details["message"] == "Test error"
        assert details["details"] == {}


# ============================================================================
# Test Exception Hierarchy
# ============================================================================


class TestExceptionHierarchy:
    """Test exception inheritance hierarchy."""

    def test_all_errors_inherit_from_base(self):
        """Test all domain errors inherit from base error."""
        exceptions = [
            {{ capability_name_pascal }}ValidationError("test"),
            {{ capability_name_pascal }}NotFoundError("test"),
            {{ capability_name_pascal }}ConflictError("test"),
            {{ capability_name_pascal }}PermissionError("test"),
            {{ capability_name_pascal }}ServiceError("test"),
            {{ capability_name_pascal }}RateLimitError("test"),
            {{ capability_name_pascal }}TimeoutError("test"),
            {{ capability_name_pascal }}ConfigError("test"),
        ]

        for exc in exceptions:
            assert isinstance(exc, {{ capability_name_pascal }}Error)
            assert isinstance(exc, Exception)

    def test_catch_all_domain_errors(self):
        """Test catching all domain errors with base class."""
        try:
            raise {{ capability_name_pascal }}ValidationError("Test")
        except {{ capability_name_pascal }}Error as e:
            assert e.message == "Test"

        try:
            raise {{ capability_name_pascal }}NotFoundError("Test")
        except {{ capability_name_pascal }}Error as e:
            assert e.message == "Test"

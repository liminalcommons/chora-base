"""Tests for {{ capability_name }} MCP Interface (SAP-043)

Tests verify MCP tools, resources, and error handling.

Generated by: chora-base SAP-047 (Capability Server Template)

Note: This test file is only included when --enable-mcp flag is used.
"""

from uuid import uuid4

import pytest

from {{ package_name }}.interfaces.mcp import mcp
from {{ package_name }}.core import {{ capability_name_pascal }}Status


# ============================================================================
# Fixtures
# ============================================================================


@pytest.fixture
def mcp_server():
    """Get MCP server instance."""
    return mcp


# ============================================================================
# Test Tool Registration
# ============================================================================


class TestToolRegistration:
    """Test MCP tools are properly registered."""

    def test_tools_registered(self, mcp_server):
        """Test all expected tools are registered."""
        tool_names = [tool.name for tool in mcp_server.list_tools()]

        expected_tools = [
            "{{ namespace }}:create",
            "{{ namespace }}:get",
            "{{ namespace }}:list",
            "{{ namespace }}:update",
            "{{ namespace }}:delete",
            "{{ namespace }}:update_status",
            "{{ namespace }}:health",
        ]

        for expected in expected_tools:
            assert expected in tool_names, f"Tool {expected} not registered"


# ============================================================================
# Test Create Tool
# ============================================================================


class TestCreateTool:
    """Test {{ namespace }}:create tool."""

    @pytest.mark.asyncio
    async def test_create_basic(self, mcp_server):
        """Test creating an entity."""
        tool = mcp_server.get_tool("{{ namespace }}:create")
        result = await tool(name="Test Entity")

        assert result["success"] is True
        assert result["entity"]["name"] == "Test Entity"
        assert "id" in result["entity"]

    @pytest.mark.asyncio
    async def test_create_with_all_fields(self, mcp_server):
        """Test creating entity with all fields."""
        tool = mcp_server.get_tool("{{ namespace }}:create")
        result = await tool(
            name="Test Entity",
            description="Test description",
            metadata={"key": "value"}
        )

        assert result["success"] is True
        assert result["entity"]["description"] == "Test description"
        assert result["entity"]["metadata"]["key"] == "value"

    @pytest.mark.asyncio
    async def test_create_invalid_name(self, mcp_server):
        """Test create with invalid name."""
        tool = mcp_server.get_tool("{{ namespace }}:create")
        result = await tool(name="")

        assert result["success"] is False
        assert "error" in result


# ============================================================================
# Test Get Tool
# ============================================================================


class TestGetTool:
    """Test {{ namespace }}:get tool."""

    @pytest.mark.asyncio
    async def test_get_existing_entity(self, mcp_server):
        """Test getting an existing entity."""
        # Create entity
        create_tool = mcp_server.get_tool("{{ namespace }}:create")
        create_result = await create_tool(name="Test Entity")
        entity_id = create_result["entity"]["id"]

        # Get entity
        get_tool = mcp_server.get_tool("{{ namespace }}:get")
        result = await get_tool(entity_id=entity_id)

        assert result["success"] is True
        assert result["entity"]["id"] == entity_id

    @pytest.mark.asyncio
    async def test_get_nonexistent_entity(self, mcp_server):
        """Test getting non-existent entity."""
        get_tool = mcp_server.get_tool("{{ namespace }}:get")
        fake_id = str(uuid4())
        result = await get_tool(entity_id=fake_id)

        assert result["success"] is False
        assert result["error"] == "NOT_FOUND"

    @pytest.mark.asyncio
    async def test_get_invalid_uuid(self, mcp_server):
        """Test get with invalid UUID."""
        get_tool = mcp_server.get_tool("{{ namespace }}:get")
        result = await get_tool(entity_id="not-a-uuid")

        assert result["success"] is False
        assert result["error"] == "INVALID_UUID"


# ============================================================================
# Test List Tool
# ============================================================================


class TestListTool:
    """Test {{ namespace }}:list tool."""

    @pytest.mark.asyncio
    async def test_list_empty(self, mcp_server):
        """Test listing when no entities exist."""
        tool = mcp_server.get_tool("{{ namespace }}:list")
        result = await tool()

        assert result["success"] is True
        assert result["entities"] == []
        assert result["total"] == 0

    @pytest.mark.asyncio
    async def test_list_with_entities(self, mcp_server):
        """Test listing with existing entities."""
        # Create some entities
        create_tool = mcp_server.get_tool("{{ namespace }}:create")
        for i in range(3):
            await create_tool(name=f"Entity {i}")

        # List all
        list_tool = mcp_server.get_tool("{{ namespace }}:list")
        result = await list_tool()

        assert result["success"] is True
        assert len(result["entities"]) == 3
        assert result["total"] == 3

    @pytest.mark.asyncio
    async def test_list_with_status_filter(self, mcp_server):
        """Test listing with status filter."""
        # Create entity and update status
        create_tool = mcp_server.get_tool("{{ namespace }}:create")
        create_result = await create_tool(name="Test Entity")
        entity_id = create_result["entity"]["id"]

        status_tool = mcp_server.get_tool("{{ namespace }}:update_status")
        await status_tool(entity_id=entity_id, new_status="active")

        # List active entities
        list_tool = mcp_server.get_tool("{{ namespace }}:list")
        result = await list_tool(status="active")

        assert result["success"] is True
        assert all(e["status"] == "active" for e in result["entities"])

    @pytest.mark.asyncio
    async def test_list_with_name_filter(self, mcp_server):
        """Test listing with name filter."""
        # Create entities
        create_tool = mcp_server.get_tool("{{ namespace }}:create")
        await create_tool(name="Alpha")
        await create_tool(name="Beta")
        await create_tool(name="Alphabet")

        # Filter by name
        list_tool = mcp_server.get_tool("{{ namespace }}:list")
        result = await list_tool(name_contains="alpha")

        assert result["success"] is True
        assert result["total"] == 2

    @pytest.mark.asyncio
    async def test_list_with_pagination(self, mcp_server):
        """Test pagination."""
        # Create 10 entities
        create_tool = mcp_server.get_tool("{{ namespace }}:create")
        for i in range(10):
            await create_tool(name=f"Entity {i}")

        # Get first page
        list_tool = mcp_server.get_tool("{{ namespace }}:list")
        result = await list_tool(offset=0, limit=5)

        assert result["success"] is True
        assert len(result["entities"]) == 5
        assert result["total"] == 10

    @pytest.mark.asyncio
    async def test_list_invalid_status(self, mcp_server):
        """Test list with invalid status."""
        list_tool = mcp_server.get_tool("{{ namespace }}:list")
        result = await list_tool(status="invalid-status")

        assert result["success"] is False
        assert result["error"] == "INVALID_STATUS"


# ============================================================================
# Test Update Tool
# ============================================================================


class TestUpdateTool:
    """Test {{ namespace }}:update tool."""

    @pytest.mark.asyncio
    async def test_update_entity(self, mcp_server):
        """Test updating an entity."""
        # Create entity
        create_tool = mcp_server.get_tool("{{ namespace }}:create")
        create_result = await create_tool(name="Original Name")
        entity_id = create_result["entity"]["id"]

        # Update entity
        update_tool = mcp_server.get_tool("{{ namespace }}:update")
        result = await update_tool(
            entity_id=entity_id,
            name="Updated Name",
            description="Updated description"
        )

        assert result["success"] is True
        assert result["entity"]["name"] == "Updated Name"

    @pytest.mark.asyncio
    async def test_update_partial(self, mcp_server):
        """Test partial update (only name)."""
        # Create entity
        create_tool = mcp_server.get_tool("{{ namespace }}:create")
        create_result = await create_tool(
            name="Original",
            description="Original description"
        )
        entity_id = create_result["entity"]["id"]

        # Update only name
        update_tool = mcp_server.get_tool("{{ namespace }}:update")
        result = await update_tool(entity_id=entity_id, name="Updated")

        assert result["success"] is True
        assert result["entity"]["name"] == "Updated"
        assert result["entity"]["description"] == "Original description"


# ============================================================================
# Test Delete Tool
# ============================================================================


class TestDeleteTool:
    """Test {{ namespace }}:delete tool."""

    @pytest.mark.asyncio
    async def test_delete_entity(self, mcp_server):
        """Test deleting an entity."""
        # Create entity
        create_tool = mcp_server.get_tool("{{ namespace }}:create")
        create_result = await create_tool(name="Test Entity")
        entity_id = create_result["entity"]["id"]

        # Delete entity
        delete_tool = mcp_server.get_tool("{{ namespace }}:delete")
        result = await delete_tool(entity_id=entity_id)

        assert result["success"] is True

        # Verify deleted
        get_tool = mcp_server.get_tool("{{ namespace }}:get")
        get_result = await get_tool(entity_id=entity_id)
        assert get_result["success"] is False


# ============================================================================
# Test Update Status Tool
# ============================================================================


class TestUpdateStatusTool:
    """Test {{ namespace }}:update_status tool."""

    @pytest.mark.asyncio
    async def test_update_status(self, mcp_server):
        """Test updating entity status."""
        # Create entity
        create_tool = mcp_server.get_tool("{{ namespace }}:create")
        create_result = await create_tool(name="Test Entity")
        entity_id = create_result["entity"]["id"]

        # Update to active
        status_tool = mcp_server.get_tool("{{ namespace }}:update_status")
        result = await status_tool(entity_id=entity_id, new_status="active")

        assert result["success"] is True
        assert result["entity"]["status"] == "active"

    @pytest.mark.asyncio
    async def test_update_status_invalid_transition(self, mcp_server):
        """Test invalid status transition."""
        # Create and complete entity
        create_tool = mcp_server.get_tool("{{ namespace }}:create")
        create_result = await create_tool(name="Test Entity")
        entity_id = create_result["entity"]["id"]

        status_tool = mcp_server.get_tool("{{ namespace }}:update_status")
        await status_tool(entity_id=entity_id, new_status="active")
        await status_tool(entity_id=entity_id, new_status="completed")

        # Try invalid transition
        result = await status_tool(entity_id=entity_id, new_status="active")

        assert result["success"] is False
        assert "VALIDATION_ERROR" in result["error"]

    @pytest.mark.asyncio
    async def test_update_status_invalid_value(self, mcp_server):
        """Test update status with invalid value."""
        fake_id = str(uuid4())
        status_tool = mcp_server.get_tool("{{ namespace }}:update_status")
        result = await status_tool(entity_id=fake_id, new_status="invalid-status")

        assert result["success"] is False
        assert result["error"] == "INVALID_STATUS"


# ============================================================================
# Test Health Tool
# ============================================================================


class TestHealthTool:
    """Test {{ namespace }}:health tool."""

    @pytest.mark.asyncio
    async def test_health_check(self, mcp_server):
        """Test health check tool."""
        tool = mcp_server.get_tool("{{ namespace }}:health")
        result = await tool()

        assert result["success"] is True
        assert "health" in result
        assert result["health"]["status"] == "healthy"


# ============================================================================
# Test Resource Registration
# ============================================================================


class TestResourceRegistration:
    """Test MCP resources are properly registered."""

    def test_resources_registered(self, mcp_server):
        """Test all expected resources are registered."""
        resource_uris = [r.uri for r in mcp_server.list_resources()]

        expected_resources = [
            "{{ namespace }}://docs/readme",
            "{{ namespace }}://docs/api-reference",
            "{{ namespace }}://docs/examples",
            "{{ namespace }}://templates/entity",
        ]

        for expected in expected_resources:
            assert expected in resource_uris, f"Resource {expected} not registered"

    @pytest.mark.asyncio
    async def test_readme_resource(self, mcp_server):
        """Test README resource content."""
        resource = mcp_server.get_resource("{{ namespace }}://docs/readme")
        content = await resource()

        assert isinstance(content, str)
        assert "{{ capability_name }}" in content
        assert "CLI" in content or "REST" in content

    @pytest.mark.asyncio
    async def test_api_reference_resource(self, mcp_server):
        """Test API reference resource content."""
        resource = mcp_server.get_resource("{{ namespace }}://docs/api-reference")
        content = await resource()

        assert isinstance(content, str)
        assert "{{ namespace }}:create" in content
        assert "Parameters" in content

    @pytest.mark.asyncio
    async def test_examples_resource(self, mcp_server):
        """Test examples resource content."""
        resource = mcp_server.get_resource("{{ namespace }}://docs/examples")
        content = await resource()

        assert isinstance(content, str)
        assert "Example" in content

    @pytest.mark.asyncio
    async def test_template_resource(self, mcp_server):
        """Test entity template resource."""
        resource = mcp_server.get_resource("{{ namespace }}://templates/entity")
        content = await resource()

        assert isinstance(content, str)
        assert "name" in content
        assert "metadata" in content

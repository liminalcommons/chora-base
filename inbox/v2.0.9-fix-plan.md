# v2.0.9 Fix Plan - Wrap ALL .format() Calls

**Date:** 2025-10-23
**Issue:** v2.0.8 still fails because `.format()` calls with `{}` are outside `{% raw %}` blocks
**Root Cause Confirmed:** Line 289 has `.format()` OUTSIDE raw block (which starts line 291)

## Test Results

✅ **Confirmed the failure:** Even creating from v1.9.3 fails with:
```
File: template/scripts/extract_tests.py.jinja, line 293
Error: unexpected char '#' at 9814
```

This is the SAME error reported in the failure analysis.

## Audit Results

Found **17 `.format()` calls** in extract_tests.py.jinja:
- Line 47: `print("Extracting tests from documentation in {}...".format(self.root_dir))`
- Line 58: `print("Found {} documents with test_extraction: true".format(len(self.docs_with_tests)))`
- Line 153: `test_name = "test_{}_example_{}".format(safe_title, idx)`
- Line 182: Multi-line `.format()` (fixture)
- Line 202: Multi-line `.format()` (async test)
- Line 237: Multi-line `.format()` (parameterized test)
- Line 254: Multi-line `.format()` (regular test)
- Line 289: `test_name = "test_{}_bash_example_{}".format(safe_title, idx)` ← **THE ERROR LINE**
- Line 304: Multi-line `.format()` (bash test) ← **Already in raw block**
- Line 313: Multi-line `.format()` (expected output)
- Line 367: Multi-line `.format()` (header)
- Line 381: `print("✅ Generated {}".format(output_file))`
- Line 382: `print("   Extracted {} test functions".format(len(self.extracted_tests)))`
- Line 384: `print("   Extracted {} fixtures".format(len(self.extracted_fixtures)))`
- Line 442: Multi-line `.format()` (bash test runner)
- Line 462: `print("✅ Generated {}".format(output_file))`
- Line 463: `print("   Extracted {} bash tests".format(len(self.bash_tests)))`

**Currently Protected:** Only 1 (line 304)
**Need to Protect:** 16 more lines

## The Dilemma

### Option A: Wrap All 16 Lines (v2.0.9 Patch)

**Approach:** Wrap each line individually in `{% raw %}...{% endraw %}`

**Example:**
```python
# Before
print("Extracting tests from documentation in {}...".format(self.root_dir))

# After
{% raw %}print("Extracting tests from documentation in {}...".format(self.root_dir)){% endraw %}
```

**Pros:**
- ✅ Keeps standard `{{ }}` delimiters
- ✅ Targeted fix for the exact issue
- ✅ Should work for both `copier copy` and `copier update`

**Cons:**
- ❌ Very verbose (16 lines to wrap)
- ❌ Hard to maintain
- ❌ May miss other files with similar issues

### Option B: Switch to Angle Brackets (v2.1.0)

**Approach:** Change delimiters to `<< >>` for variables, `<% %>` for blocks

**Example:**
```yaml
# copier.yml
_envops:
  variable_start_string: "<<"
  variable_end_string: ">>"
  block_start_string: "<%"
  block_end_string: "%>"
  comment_start_string: "<#"
  comment_end_string: "#>"
```

**Pros:**
- ✅ Eliminates ALL Python `{}` conflicts
- ✅ No raw blocks needed for Python code
- ✅ Cleaner template files
- ✅ Recommended by "Solution Analysis" research

**Cons:**
- ❌ Contradicts "Delimiter Problem" research
- ❌ Requires mass conversion (1,717 elements)
- ❌ May introduce heredoc conflicts (`<<EOF`)
- ❌ More testing required

## Research Conflict Analysis

### "Delimiter Problem" Research Says:
> "Zero production templates use angle brackets. All use standard `{{ }}`"
> "F-strings in template files work fine"

**BUT** our testing shows this is **FALSE** for our template!

### "Solution Analysis" Says:
> "Angle brackets `<< >>` are optimal for Python + Markdown"
> "No conflicts with `{}` syntax"

This aligns with our findings!

## Recommendation

**I recommend Option B (angle brackets)** because:

1. **The "Delimiter Problem" research is wrong** for our use case
2. **Standard delimiters don't work** (we just proved it)
3. **16 raw block wrappers is unmaintainable**
4. **Angle brackets eliminate the entire class of conflicts**

However, this is a bigger change. If you want a **quick patch first**, we can do Option A (v2.0.9), then Option B (v2.1.0) later.

## Decision Needed

**Question:** Should I:
1. **Proceed with Option A** (wrap 16 lines, release v2.0.9 patch)
2. **Switch to Option B** (angle brackets, release v2.1.0)
3. **Do both** (v2.0.9 patch first, then v2.1.0 with angle brackets)

Please advise how you'd like to proceed.
